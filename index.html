<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chrome Â∞èÊÅêÈæôÊ∏∏Êàè</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
        }
        
        body {
            background-color: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            touch-action: none;
        }
        
        #menuScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }
        
        #menuTitle {
            font-size: 2.5rem;
            margin-bottom: 2rem;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .menu-btn {
            width: 200px;
            padding: 12px 24px;
            margin: 10px;
            background: rgba(102, 126, 234, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .menu-btn:hover {
            transform: scale(1.05);
            background: rgba(122, 146, 254, 0.9);
        }
        
        #musicControls {
            position: absolute;
            bottom: 50px;
            display: flex;
            gap: 10px;
        }
        
        .music-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        
        #gameContainer {
            background-color: #000;
            border: none;
            box-shadow: none;
            width: 100%;
            height: 100%;
            position: relative;
            display: none;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            touch-action: none;
        }
        
        #controlPanel {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        
        #pauseButton {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: black;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            touch-action: manipulation;
            backdrop-filter: blur(10px);
        }
        
        #pauseButton:active {
            transform: scale(0.95);
        }
        
        #gmButton {
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            touch-action: manipulation;
            backdrop-filter: blur(10px);
        }
        
        #gmButton:active {
            transform: scale(0.95);
        }
        
        #gmButton.active {
            background: rgba(245, 87, 108, 0.9);
            animation: pulse 1s infinite;
        }
        
        #gmButton span {
            font-size: 11px;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(245, 87, 108, 0.5);
            }
            50% {
                box-shadow: 0 2px 15px rgba(245, 87, 108, 0.8);
            }
        }
        
        #musicToggle {
            padding: 6px 12px;
            background: rgba(255, 193, 7, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            touch-action: manipulation;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        #musicToggle:active {
            transform: scale(0.95);
        }
        
        #endButton {
            padding: 6px 12px;
            background: rgba(220, 53, 69, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            touch-action: manipulation;
            backdrop-filter: blur(10px);
            display: none;
        }
        
        #endButton:active {
            transform: scale(0.95);
        }
        
        #controls {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            gap: 15px;
            pointer-events: none;
            z-index: 10;
        }
        
        .control-btn {
            width: 80px;
            height: 80px;
            border: 3px solid #000000;
            border-radius: 40px;
            background: transparent;
            font-size: 20px;
            font-weight: bold;
            color: #000000;
            cursor: pointer;
            transition: all 0.1s;
            touch-action: manipulation;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            pointer-events: auto;
        }
        
        .control-btn:active {
            background: rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
        }
        
        .control-btn span {
            font-size: 12px;
            margin-top: 5px;
            color: #000000;
        }
        
        #laserCooldown {
            position: absolute;
            bottom: 120px;
            right: 20px;
            width: 100px;
            height: 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: none;
            z-index: 10;
            pointer-events: none;
        }
        
        #laserCooldownBar {
            width: 0%;
            height: 100%;
            background: linear-gradient(to right, #ff6b6b, #ffd93d);
            border-radius: 8px;
            transition: width 0.1s;
        }
        
        #laserCooldownText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        #superLaserCharge {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: none;
            z-index: 10;
            pointer-events: none;
        }
        
        #superLaserChargeBar {
            width: 0%;
            height: 100%;
            background: linear-gradient(to right, #ff0000, #ff8800, #ffff00);
            border-radius: 8px;
            transition: width 0.3s ease;
        }
        
        #superLaserChargeText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            color: white;
        }
        
        .game-over-btn {
            width: 180px;
            padding: 12px 24px;
            margin: 10px;
            background: rgba(102, 126, 234, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .game-over-btn:hover {
            transform: scale(1.05);
        }
        
        #lightningBtn {
            position: absolute;
            bottom: 120px;
            right: 20px;
            display: none;
        }
        
        .screen-shake {
            animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
            40%, 60% { transform: translate3d(3px, 0, 0); }
        }
        
        .hit-border {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 5px solid rgba(255, 0, 0, 0.3);
            pointer-events: none;
            z-index: 50;
        }
        
        #lightningCooldown {
            position: absolute;
            bottom: 200px;
            right: 20px;
            width: 100px;
            height: 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: none;
            z-index: 10;
            pointer-events: none;
        }
        
        #lightningCooldownBar {
            width: 0%;
            height: 100%;
            background: linear-gradient(to right, #0077ff, #00ccff);
            border-radius: 8px;
            transition: width 0.3s;
        }
        
        #lightningCooldownText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
            font-weight: bold;
        }
        
        .screen-red-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.5);
            pointer-events: none;
            z-index: 150;
        }
        
        .explosion-effect {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 100, 100, 0.5);
            pointer-events: none;
            z-index: 149;
        }
        
        .difficulty-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 0, 0, 0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 12px;
            z-index: 100;
            display: none;
        }
    </style>
</head>
<body>
    <div id="menuScreen">
        <h1 id="menuTitle">Â∞èÊÅêÈæô 2</h1>
        <button class="menu-btn" id="startBtn">
            ‚ñ∂ ÂºÄÂßãÊ∏∏Êàè
        </button>
        <div id="musicControls">
            <button class="music-btn" id="playMusicBtn">‚ñ∂ Êí≠ÊîæÈü≥‰πê</button>
            <button class="music-btn" id="pauseMusicBtn">‚è∏ ÊöÇÂÅúÈü≥‰πê</button>
            <button class="music-btn" id="nextMusicBtn">‚è≠ ‰∏ã‰∏ÄÈ¶ñ</button>
        </div>
    </div>

    <div id="gameOverScreen">
        <h1 id="gameOverTitle">Ê∏∏ÊàèÁªìÊùü</h1>
        <p id="gameOverMessage">Êó∂Èó¥Â∑≤Âà∞20ÂàÜÈíüÔºÅ</p>
        <button class="game-over-btn" id="continueBtn">ÁªßÁª≠Êñ∞Ê∏∏Êàè</button>
        <button class="game-over-btn" id="endlessBtn">Êó†Â∞ΩÊ®°Âºè</button>
    </div>

    <div id="gameContainer">
        <div id="controlPanel">
            <button id="pauseButton" onclick="togglePause()">
                ‚è∏
                <span id="pauseStatus">ÊöÇÂÅú</span>
            </button>
            <button id="gmButton" onclick="toggleGM()">
                GM
                <span id="gmStatus">OFF</span>
            </button>
            <button id="musicToggle" onclick="toggleMusic()">
                üéµ
                <span>Èü≥‰πê</span>
            </button>
            <button id="endButton" onclick="endGame()">
                ‚èπ
                <span>ÁªìÊùü</span>
            </button>
        </div>
        <canvas id="gameCanvas"></canvas>
        
        <div id="laserCooldown">
            <div id="laserCooldownBar"></div>
            <div id="laserCooldownText">0%</div>
        </div>
        
        <div id="superLaserCharge">
            <div id="superLaserChargeBar"></div>
            <div id="superLaserChargeText">Ë∂ÖÁ∫ßÊøÄÂÖâÂÖÖËÉΩ: 0%</div>
        </div>
        
        <div id="lightningCooldown">
            <div id="lightningCooldownBar"></div>
            <div id="lightningCooldownText">0s</div>
        </div>
        
        <div class="difficulty-indicator" id="difficultyIndicator">
            Âõ∞ÈöæÊ®°Âºè
        </div>
        
        <div id="controls">
            <button class="control-btn" id="jumpBtn">
                ‚Üë
                <span>Ë∑≥Ë∑É</span>
            </button>
            <button class="control-btn" id="fireBtn">
                üî•
                <span>ÂèëÂ∞Ñ</span>
            </button>
            <button class="control-btn" id="lightningBtn">
                ‚ö°
                <span>Èó™Áîµ</span>
            </button>
        </div>
    </div>
    
    <div id="hitBorder" class="hit-border" style="display: none;"></div>
    
    <script>
        // ===============================
        // Èü≥‰πêÁ≥ªÁªü - ÈöèÊú∫Êí≠ÊîæÁâàÊú¨
        // ===============================
        let musicEnabled = true;
        let currentMusicIndex = 0;
        let audioElement = null;
        let isMusicPlaying = false;

        const musicFiles = [
            'music/bgm1.mp3',
            'music/bgm2.mp3', 
            'music/bgm3.mp3',
            'music/bgm4.mp3',
            'music/bgm5.mp3',
            'music/bgm6.mp3'
        ];

        function initMusic() {
            try {
                audioElement = new Audio();
                audioElement.loop = false;
                audioElement.volume = 0.5;
                
                audioElement.addEventListener('ended', function() {
                    playRandomMusic();
                });
                
                console.log("Èü≥‰πêÁ≥ªÁªüÂ∑≤ÂàùÂßãÂåñÔºåÂä†ËΩΩ‰∫Ü " + musicFiles.length + " È¶ñÈü≥‰πê");
                isMusicPlaying = false;
            } catch (e) {
                console.log("Èü≥‰πêÁ≥ªÁªüÂàùÂßãÂåñÂ§±Ë¥•:", e);
                musicEnabled = false;
            }
        }

        function playRandomMusic() {
            if (!musicEnabled || musicFiles.length === 0) return;
            
            let newIndex;
            if (musicFiles.length > 1) {
                do {
                    newIndex = Math.floor(Math.random() * musicFiles.length);
                } while (newIndex === currentMusicIndex);
            } else {
                newIndex = 0;
            }
            
            currentMusicIndex = newIndex;
            audioElement.src = musicFiles[currentMusicIndex];
            audioElement.load();
            
            console.log("ÈöèÊú∫Êí≠ÊîæÈü≥‰πê: " + (currentMusicIndex + 1) + "/" + musicFiles.length);
            
            audioElement.play().then(() => {
                isMusicPlaying = true;
                updateMusicToggleButton();
            }).catch(e => {
                console.log("Êí≠ÊîæÈü≥‰πêÂ§±Ë¥•:", e);
            });
        }

        function playMusic() {
            if (!musicEnabled || !audioElement) return;
            try {
                if (!audioElement.src || audioElement.src === "") {
                    playRandomMusic();
                    return;
                }
                
                audioElement.play().then(() => {
                    isMusicPlaying = true;
                    updateMusicToggleButton();
                }).catch(e => {
                    console.log("Êí≠ÊîæÈü≥‰πêÂ§±Ë¥•:", e);
                });
            } catch (e) {
                console.log("Êí≠ÊîæÈü≥‰πêÂá∫Èîô:", e);
            }
        }

        function pauseMusic() {
            if (!musicEnabled || !audioElement) return;
            try {
                audioElement.pause();
                isMusicPlaying = false;
                updateMusicToggleButton();
                console.log("Èü≥‰πêÂ∑≤ÊöÇÂÅú");
            } catch (e) {
                console.log("ÊöÇÂÅúÈü≥‰πêÂá∫Èîô:", e);
            }
        }

        function stopMusic() {
            if (!musicEnabled || !audioElement) return;
            try {
                audioElement.pause();
                audioElement.currentTime = 0;
                isMusicPlaying = false;
                updateMusicToggleButton();
                console.log("Èü≥‰πêÂ∑≤ÂÅúÊ≠¢");
            } catch (e) {
                console.log("ÂÅúÊ≠¢Èü≥‰πêÂá∫Èîô:", e);
            }
        }

        function nextMusic() {
            console.log("‰∏ã‰∏ÄÈ¶ñÊåâÈíÆÁÇπÂáª");
            playRandomMusic();
        }

        function toggleMusic() {
            if (!musicEnabled) return;
            if (audioElement.paused || !isMusicPlaying) {
                playMusic();
            } else {
                pauseMusic();
            }
        }

        function updateMusicToggleButton() {
            const musicToggle = document.getElementById('musicToggle');
            if (musicToggle) {
                if (isMusicPlaying) {
                    musicToggle.innerHTML = 'üîä<span>Èü≥‰πê</span>';
                } else {
                    musicToggle.innerHTML = 'üîá<span>Èü≥‰πê</span>';
                }
            }
        }

        initMusic();

        // ===============================
        // Ê∏∏ÊàèÊ†∏ÂøÉÂèòÈáèÂíåÂàùÂßãÂåñ
        // ===============================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Ê∏∏ÊàèÁä∂ÊÄÅÂèòÈáè
        let gameRunning = false;
        let gameOver = false;
        let score = 0;
        let highScore = localStorage.getItem('dinoHighScore') || 0;
        let gameSpeed = 3;
        let frameCount = 0;
        let gmMode = false;
        let gamePaused = false;
        let endlessMode = false;
        let preGMLevel = 1;
        
        let gameTime = 0;
        const MAX_GAME_TIME = 20 * 60;
        
        const MAX_FIREBALL_LEVEL = 180;
        let lives = 5;
        let maxLives = 5;
        let isInvulnerable = false;
        let invulnerableFlash = 0;
        let lastLifeBonus = 0;
        let lastLifeUpBonus = 0;
        
        // Êñ∞Â¢ûÂõ∞ÈöæÊ®°Âºè„ÄÅÂô©Ê¢¶Ê®°Âºè„ÄÅÂú∞Áã±Ê®°Âºè
        let hardMode = false;
        let nightmareMode = false;
        let hellMode = false;
        let hardModeMultiplier = 1;
        let hardModeStartScore = 0;
        let nightmareModeStartScore = 0;
        let hellModeStartScore = 0;
        
        const HARD_MODE_THRESHOLD = 150000; // 15‰∏áÂàÜÂõ∞ÈöæÊ®°Âºè
        const NIGHTMARE_MODE_THRESHOLD = 5000000; // 500‰∏áÂàÜÂô©Ê¢¶Ê®°Âºè
        const HELL_MODE_THRESHOLD = 10000000; // 1000‰∏áÂàÜÂú∞Áã±Ê®°Âºè
        
        // Êñ∞Â¢ûË¢´Âä®ÊäÄËÉΩÂèòÈáè
        let passiveScoreMultiplier = 1; // 80Á∫ßË¢´Âä®ÔºöÂàÜÊï∞x2
        let passiveBuffMultiplier = 1; // 90Á∫ßË¢´Âä®ÔºöÂ¢ûÁõäÊïàÊûúx2
        let immuneObstacle = false; // 100Á∫ßË¢´Âä®ÔºöÂÖçÁñ´ÈöúÁ¢çÁâ©‰º§ÂÆ≥
        let immuneFireball = false; // 130Á∫ßË¢´Âä®ÔºöÂÖçÁñ´ÁÅ´ÁêÉ‰º§ÂÆ≥
        let immuneBomb = false; // 140Á∫ßË¢´Âä®ÔºöÂÖçÁñ´ÁÇ∏Âºπ‰º§ÂÆ≥
        
        // Â§©Ê∞îÁ≥ªÁªüÂèòÈáè
        let currentWeather = 'sunny'; // sunny, rainy, snowy
        let weatherTimer = 0;
        const WEATHER_CHANGE_INTERVAL = 36000;
        let snowParticles = [];
        
        let isDarkMode = false;
        let themeTransition = 0;
        let targetDarkMode = false;
        let themeTimer = 0;
        
        let barrierCount = 0;
        let barrierFlash = 0;
        
        let invincibleTime = 0;
        let powerUpTime = 0;
        let scoreMultiplier = 1;
        let healOverTime = 0;
        let healOverTimeTimer = 0;
        
        let fireballLevel = 1;
        let fireballDamage = 1;
        let hasInfinitePenetration = false;
        let infinitePenetrationTime = 0;
        let lastFireballBonus = 0;
        
        // 70Á∫ßË¢´Âä®ÊäÄËÉΩÂèòÈáè
        let passiveBarrierTimer = 0;
        let lastPassiveBarrierScore = 0;
        
        // Ë∂ÖÁ∫ßÊøÄÂÖâÂèòÈáè
        let laserActive = false;
        let laserCooldown = 0;
        let laserDuration = 0;
        let laserCharge = 0;
        let isFiringLaser = false;
        
        let superLaserActive = false;
        let superLaserDuration = 0;
        let superLaserChargeProgress = 0;
        let superLaserWidth = 20;
        let superLaserHeight = canvas.height;
        let superLaserExpanding = false;
        let superLaserReady = false;
        let superLaserExpandSpeed = 0.2;
        let isFiringSuperLaser = false;
        let isFiringMiniLaser = false;
        
        // Ë∂ÖÁ∫ßÊøÄÂÖâÈÖçÁΩÆÂèòÈáè
        let superLaserChargeTime = 20; // Âü∫Á°ÄÂÖÖËÉΩÊó∂Èó¥20Áßí
        let superLaserDamageMultiplier = 16; // Âü∫Á°Ä‰º§ÂÆ≥ÂÄçÁéá16ÂÄç
        let superLaserDurationTime = 15; // Âü∫Á°ÄÊåÅÁª≠Êó∂Èó¥15Áßí
        let superLaserInstantKill = false; // ÊòØÂê¶ÁßíÊùÄÊâÄÊúâÂçï‰Ωç
        
        let lightningSkillActive = false;
        let lightningSkillDuration = 0;
        let lightningSkillCooldown = 0;
        let lightningSkillOriginalDarkMode = false;
        let lightningSkillOriginalTransition = 0;
        let rainParticles = [];
        let lightningBolts = [];
        let lastLightningTime = 0;
        let lightningSkillUpgraded = false;
        
        // ÁàÜÁÇ∏ÊïàÊûúÁõ∏ÂÖ≥
        let explosionEffects = [];
        let explosionParticles = [];
        
        let particles = [];
        let fireballs = [];
        let powerUps = [];
        let enemies = [];
        let enemyFireballs = [];
        let trucks = [];
        let birdBombs = [];
        let bombPlanes = [];
        let bombs = [];
        
        let enemyPowerUps = {
            powerUpTime: 0,
            infinitePenetrationTime: 0,
            damageMultiplier: 1
        };
        
        let screenShake = 0;
        let hitEffect = 0;
        let lastDamageTaken = 0;
        
        let obstacles = [];
        let clouds = [];
        
        // ÁâπÊÆäÊïå‰∫∫ÂÜ∑Âç¥Êó∂Èó¥
        let specialEnemyCooldowns = {
            truck: 0,
            bombPlane: 0,
            birdBomb: 0
        };
        
        // ÂêåÊó∂Â≠òÂú®ÁöÑÁâπÊÆäÊïå‰∫∫Êï∞ÈáèÈôêÂà∂
        const MAX_SPECIAL_ENEMIES = {
            trucks: 1,
            bombPlanes: 1,
            birdBombs: 2
        };
        
        // Â∞èÈ∏üÁÇ∏ÂºπÁ±ª
        class BirdBomb {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 46;
                this.height = 30;
                this.speed = gameSpeed * 1.2;
                this.isExploded = false;
                this.explosionTimer = 0;
                this.birdFrame = 0;
                this.color = '#ff4444';
                this.damage = 10 * hardModeMultiplier;
                this.isLaserHit = false;
            }
            
            update() {
                if (this.isExploded) {
                    this.explosionTimer++;
                    if (this.explosionTimer > 15) {
                        return true;
                    }
                    return false;
                }
                
                this.x -= this.speed;
                
                if (frameCount % 10 === 0) {
                    this.birdFrame = (this.birdFrame + 1) % 2;
                }
                
                if (this.x + this.width < 0) {
                    return true;
                }
                
                return false;
            }
            
            draw() {
                if (this.isExploded) {
                    const explosionSize = this.explosionTimer * 5;
                    const alpha = 1 - (this.explosionTimer / 15);
                    
                    ctx.fillStyle = `rgba(255, 100, 0, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/2, this.y + this.height/2, explosionSize/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = `rgba(255, 200, 0, ${alpha * 0.5})`;
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/2, this.y + this.height/2, explosionSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    return;
                }
                
                ctx.fillStyle = this.color;
                
                ctx.save();
                ctx.scale(-1, 1);
                ctx.translate(-this.x * 2 - this.width, 0);
                
                ctx.fillRect(this.x + 10, this.y + 10, 26, 10);
                ctx.fillRect(this.x + 30, this.y + 6, 10, 8);
                ctx.fillRect(this.x + 40, this.y + 8, 4, 4);
                ctx.fillRect(this.x + 36, this.y + 8, 2, 2);
                
                if (this.birdFrame === 0) {
                    ctx.fillRect(this.x + 14, this.y, 16, 8);
                } else {
                    ctx.fillRect(this.x + 14, this.y + 12, 16, 8);
                }
                
                ctx.fillRect(this.x, this.y + 12, 10, 6);
                
                ctx.fillStyle = '#ffff00';
                ctx.fillRect(this.x + 20, this.y + 5, 4, 4);
                ctx.fillRect(this.x + 22, this.y + 3, 1, 8);
                
                ctx.restore();
            }
            
            explode(isLaserHit = false) {
                if (this.isExploded) return;
                
                this.isExploded = true;
                this.explosionTimer = 0;
                this.isLaserHit = isLaserHit;
                
                if (isLaserHit) {
                    triggerGlobalExplosion(this.x + this.width/2, this.y + this.height/2, 10);
                    this.applyDamage();
                }
                
                return true;
            }
            
            applyDamage() {
                if (barrierCount > 0) {
                    barrierCount--;
                } else if (!gmMode && invincibleTime <= 0 && !immuneBomb) {
                    lives -= this.damage;
                    triggerScreenShake(this.damage);
                    
                    if (lives <= 0) {
                        gameOver = true;
                        if (score > highScore) {
                            highScore = score;
                            localStorage.setItem('dinoHighScore', highScore);
                        }
                    }
                }
                
                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    enemy.takeDamage(5);
                    if (enemy.health <= 0) {
                        createExplosion(enemy.x, enemy.y, enemy.width, enemy.height);
                        enemies.splice(i, 1);
                        score += enemy.level * 10 * passiveScoreMultiplier * getScoreMultiplier();
                    }
                }
            }
            
            getHitbox() {
                return {
                    x: this.x + 10,
                    y: this.y + 6,
                    width: 34,
                    height: 18
                };
            }
        }
        
        // ÁÇ∏ÂºπÈ£ûÊú∫Á±ª
        class BombPlane {
            constructor() {
                this.x = canvas.width;
                this.y = 50;
                this.width = 80;
                this.height = 40;
                this.speed = gameSpeed * 1.5;
                this.bombCooldown = 60;
                this.bombInterval = 120;
                this.health = 5 * hardModeMultiplier;
                this.color = '#888888';
                this.isExploded = false;
                this.explosionTimer = 0;
            }
            
            update() {
                if (this.isExploded) {
                    this.explosionTimer++;
                    if (this.explosionTimer > 15) {
                        return true;
                    }
                    return false;
                }
                
                this.x -= this.speed;
                this.bombCooldown--;
                
                if (this.bombCooldown <= 0 && this.x < canvas.width - 100) {
                    this.dropBomb();
                    this.bombCooldown = this.bombInterval;
                }
                
                if (this.x + this.width < 0) {
                    return true;
                }
                
                return false;
            }
            
            dropBomb() {
                bombs.push(new Bomb(this.x + this.width/2, this.y + this.height));
            }
            
            draw() {
                if (this.isExploded) {
                    const explosionSize = this.explosionTimer * 5;
                    const alpha = 1 - (this.explosionTimer / 15);
                    
                    ctx.fillStyle = `rgba(255, 100, 0, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/2, this.y + this.height/2, explosionSize/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = `rgba(255, 200, 0, ${alpha * 0.5})`;
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/2, this.y + this.height/2, explosionSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    return;
                }
                
                ctx.fillStyle = this.color;
                
                ctx.fillRect(this.x, this.y + 15, this.width, 10);
                
                ctx.fillRect(this.x + 10, this.y, 60, 10);
                ctx.fillRect(this.x + 10, this.y + 25, 60, 10);
                
                ctx.fillRect(this.x + 70, this.y + 5, 5, 20);
                
                ctx.fillStyle = '#00aaff';
                ctx.fillRect(this.x + 60, this.y + 5, 15, 10);
            }
            
            explode() {
                if (this.isExploded) return;
                
                this.isExploded = true;
                this.explosionTimer = 0;
                
                triggerGlobalExplosion(this.x + this.width/2, this.y + this.height/2, 10);
                this.applyDamage();
                
                return true;
            }
            
            applyDamage() {
                if (barrierCount > 0) {
                    barrierCount--;
                } else if (!gmMode && invincibleTime <= 0 && !immuneBomb) {
                    lives -= 10 * hardModeMultiplier;
                    triggerScreenShake(10 * hardModeMultiplier);
                    
                    if (lives <= 0) {
                        gameOver = true;
                        if (score > highScore) {
                            highScore = score;
                            localStorage.setItem('dinoHighScore', highScore);
                        }
                    }
                }
                
                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    enemy.takeDamage(5);
                    if (enemy.health <= 0) {
                        createExplosion(enemy.x, enemy.y, enemy.width, enemy.height);
                        enemies.splice(i, 1);
                        score += enemy.level * 10 * passiveScoreMultiplier * getScoreMultiplier();
                    }
                }
            }
            
            getHitbox() {
                return {
                    x: this.x,
                    y: this.y,
                    width: this.width,
                    height: this.height
                };
            }
        }
        
        // ÁÇ∏ÂºπÁ±ª
        class Bomb {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 15;
                this.height = 15;
                this.speed = 8;
                this.damage = (25 + Math.floor(Math.random() * 11)) * hardModeMultiplier;
                this.color = '#ff0000';
                this.isExploded = false;
                this.explosionTimer = 0;
                this.trailTimer = 0;
            }
            
            update() {
                if (this.isExploded) {
                    this.explosionTimer++;
                    if (this.explosionTimer > 15) {
                        return true;
                    }
                    return false;
                }
                
                this.y += this.speed;
                this.trailTimer++;
                
                if (this.trailTimer % 10 === 0) {
                    particles.push(new Particle(this.x, this.y, '#ff6600'));
                }
                
                if (this.y > canvas.height - 30) {
                    this.explode();
                }
                
                return false;
            }
            
            draw() {
                if (this.isExploded) {
                    const explosionSize = this.explosionTimer * 5;
                    const alpha = 1 - (this.explosionTimer / 15);
                    
                    ctx.fillStyle = `rgba(255, 100, 0, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, explosionSize/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    return;
                }
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.width/2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#ffff00';
                ctx.fillRect(this.x - 2, this.y - 10, 4, 8);
                
                ctx.fillStyle = '#ff6666';
                ctx.beginPath();
                ctx.arc(this.x - 3, this.y - 3, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            explode() {
                if (this.isExploded) return;
                
                this.isExploded = true;
                this.explosionTimer = 0;
                
                const dinoHitbox = dino.getHitbox();
                const bombHitbox = this.getHitbox();
                
                if (checkCollision(dinoHitbox, bombHitbox)) {
                    if (barrierCount > 0) {
                        barrierCount--;
                    } else if (!gmMode && invincibleTime <= 0 && !immuneBomb) {
                        lives -= this.damage;
                        triggerScreenShake(this.damage);
                        
                        if (lives <= 0) {
                            gameOver = true;
                            if (score > highScore) {
                                highScore = score;
                                localStorage.setItem('dinoHighScore', highScore);
                            }
                        }
                    }
                }
                
                return true;
            }
            
            getHitbox() {
                return {
                    x: this.x - this.width/2,
                    y: this.y - this.height/2,
                    width: this.width,
                    height: this.height
                };
            }
        }
        
        // Ëß¶ÂèëÂÖ®Â±ÄÁàÜÁÇ∏ÊïàÊûú
        function triggerGlobalExplosion(x, y, damage) {
            for (let i = 0; i < 10; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 5 + Math.random() * 10;
                const size = 3 + Math.random() * 5;
                const life = 20 + Math.random() * 20;
                
                explosionParticles.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    size: size,
                    color: `rgba(255, ${Math.floor(100 + Math.random() * 155)}, 0, 1)`,
                    life: life,
                    maxLife: life
                });
            }
            
            explosionEffects.push({
                x: 0,
                y: 0,
                width: canvas.width,
                height: canvas.height,
                alpha: 0.7,
                life: 10
            });
        }
        
        // ===============================
        // ÂàõÂª∫ÊµÆÂä®ÊñáÊú¨ÂáΩÊï∞
        // ===============================
        function createFloatingText(text, x, y, color, duration) {
            particles.push({
                x: x,
                y: y,
                vx: 0,
                vy: -1,
                life: duration,
                maxLife: duration,
                text: text,
                color: color || '#ffffff',
                fontSize: 16,
                type: 'text',
                isDead: function() { return this.life <= 0; }
            });
        }

        // Á≤íÂ≠êÁ±ª
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 10;
                this.vy = (Math.random() - 0.5) * 10 - 2;
                this.life = 1;
                this.decay = 0.02;
                this.size = Math.random() * 4 + 2;
                this.color = color || '#535353';
                this.gravity = 0.3;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += this.gravity;
                this.life -= this.decay;
                this.vx *= 0.99;
            }
            
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x - this.size/2, this.y - this.size/2, this.size, this.size);
                ctx.globalAlpha = 1;
            }
            
            isDead() {
                return this.life <= 0;
            }
        }
        
        // Èõ®Êª¥Á≤íÂ≠ê
        class RainParticle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height - canvas.height;
                this.speed = 10 + Math.random() * 10;
                this.length = 10 + Math.random() * 10;
                this.thickness = 1;
            }
            
            update() {
                this.y += this.speed;
                this.x += 0.5;
                
                if (this.y > canvas.height) {
                    this.y = Math.random() * canvas.height - canvas.height;
                    this.x = Math.random() * canvas.width;
                }
            }
            
            draw() {
                ctx.strokeStyle = 'rgba(100, 150, 255, 0.6)';
                ctx.lineWidth = this.thickness;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(this.x, this.y + this.length);
                ctx.stroke();
            }
        }
        
        // Èõ™Ëä±Á≤íÂ≠ê
        class SnowParticle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height - canvas.height;
                this.speed = 2 + Math.random() * 3;
                this.size = 2 + Math.random() * 3;
                this.wind = Math.random() * 1 - 0.5;
            }
            
            update() {
                this.y += this.speed;
                this.x += this.wind;
                
                if (this.y > canvas.height) {
                    this.y = Math.random() * canvas.height - canvas.height;
                    this.x = Math.random() * canvas.width;
                }
            }
            
            draw() {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }
        
        // Èó™ÁîµÁ±ª
        class LightningBolt {
            constructor(targetX, targetY) {
                this.x = targetX;
                this.y = targetY;
                this.life = 20;
                this.branches = [];
                this.createBranches();
            }
            
            createBranches() {
                const startY = 0;
                const endY = this.y;
                const segments = 3;
                const segmentHeight = (endY - startY) / segments;
                
                let lastX = this.x;
                let lastY = startY;
                
                for (let i = 1; i <= segments; i++) {
                    const newY = lastY + segmentHeight;
                    const newX = lastX + (Math.random() - 0.5) * 30;
                    
                    this.branches.push({
                        startX: lastX,
                        startY: lastY,
                        endX: newX,
                        endY: newY
                    });
                    
                    lastX = newX;
                    lastY = newY;
                    
                    if (Math.random() > 0.8) {
                        const branchLength = 10 + Math.random() * 20;
                        const branchAngle = Math.random() * Math.PI * 2;
                        
                        this.branches.push({
                            startX: newX,
                            startY: newY,
                            endX: newX + Math.cos(branchAngle) * branchLength,
                            endY: newY + Math.sin(branchAngle) * branchLength
                        });
                    }
                }
            }
            
            update() {
                this.life--;
            }
            
            draw() {
                const alpha = this.life / 20;
                ctx.strokeStyle = `rgba(255, 255, 200, ${alpha})`;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                
                for (const branch of this.branches) {
                    ctx.beginPath();
                    ctx.moveTo(branch.startX, branch.startY);
                    ctx.lineTo(branch.endX, branch.endY);
                    ctx.stroke();
                }
                
                ctx.shadowBlur = 5;
                ctx.shadowColor = 'rgba(100, 150, 255, 0.5)';
                
                ctx.lineWidth = 1;
                
                for (const branch of this.branches) {
                    ctx.beginPath();
                    ctx.moveTo(branch.startX, branch.startY);
                    ctx.lineTo(branch.endX, branch.endY);
                    ctx.stroke();
                }
                
                ctx.shadowBlur = 0;
            }
            
            isDead() {
                return this.life <= 0;
            }
        }
        
        // ÂàõÂª∫ÁàÜÁÇ∏ÊïàÊûú
        function createExplosion(x, y, width, height) {
            const particleCount = 3;
            const colors = ['#535353', '#ff6b6b', '#ffd93d', '#ff8c42'];
            
            for (let i = 0; i < particleCount; i++) {
                const px = x + Math.random() * width;
                const py = y + Math.random() * height;
                const color = colors[Math.floor(Math.random() * colors.length)];
                particles.push(new Particle(px, py, color));
            }
        }
        
        // ===============================
        // Ê∏∏ÊàèÊéßÂà∂ÂáΩÊï∞
        // ===============================
        // ÂºÄÂßãÊ∏∏ÊàèÊåâÈíÆ
        document.getElementById('startBtn').addEventListener('click', function() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            resetGame();
            
            if (musicEnabled && audioElement) {
                if (!isMusicPlaying) {
                    playRandomMusic();
                }
            }
        });
        
        document.getElementById('playMusicBtn').addEventListener('click', function() {
            console.log("Êí≠ÊîæÈü≥‰πêÊåâÈíÆÁÇπÂáª");
            playMusic();
        });
        
        document.getElementById('pauseMusicBtn').addEventListener('click', function() {
            console.log("ÊöÇÂÅúÈü≥‰πêÊåâÈíÆÁÇπÂáª");
            pauseMusic();
        });
        
        document.getElementById('nextMusicBtn').addEventListener('click', function() {
            console.log("‰∏ã‰∏ÄÈ¶ñÊåâÈíÆÁÇπÂáª");
            nextMusic();
        });
        
        // ÊöÇÂÅúÊ∏∏Êàè
        function togglePause() {
            gamePaused = !gamePaused;
            const pauseButton = document.getElementById('pauseButton');
            const pauseStatus = document.getElementById('pauseStatus');
            const musicToggle = document.getElementById('musicToggle');
            const endButton = document.getElementById('endButton');
            
            if (gamePaused) {
                pauseButton.innerHTML = '‚ñ∂<span>ÁªßÁª≠</span>';
                pauseButton.style.background = 'rgba(51, 217, 178, 0.9)';
                musicToggle.style.display = 'flex';
                endButton.style.display = 'flex';
                
                if (isMusicPlaying) {
                    document.getElementById('musicToggle').innerHTML = 'üîä<span>Èü≥‰πê</span>';
                } else {
                    document.getElementById('musicToggle').innerHTML = 'üîá<span>Èü≥‰πê</span>';
                }
                
                document.getElementById('musicToggle').onclick = toggleMusic;
            } else {
                pauseButton.innerHTML = '‚è∏<span>ÊöÇÂÅú</span>';
                pauseButton.style.background = 'rgba(255, 255, 255, 0.2)';
                musicToggle.style.display = 'none';
                endButton.style.display = 'none';
            }
        }
        
        // ÁªìÊùüÊ∏∏ÊàèÔºàËøîÂõûËèúÂçïÔºâ
        function endGame() {
            gamePaused = false;
            gameOver = true;
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('dinoHighScore', highScore);
            }
            
            document.getElementById('menuScreen').style.display = 'flex';
            document.getElementById('gameContainer').style.display = 'none';
            
            document.getElementById('pauseButton').innerHTML = '‚è∏<span>ÊöÇÂÅú</span>';
            document.getElementById('pauseButton').style.background = 'rgba(255, 255, 255, 0.2)';
            document.getElementById('musicToggle').style.display = 'none';
            document.getElementById('endButton').style.display = 'none';
            
            stopMusic();
        }
        window.endGame = endGame;
        
        // GMÊ®°ÂºèÂàáÊç¢
        function toggleGM() {
            const gmButton = document.getElementById('gmButton');
            const gmStatus = document.getElementById('gmStatus');
            
            if (!gmMode) {
                preGMLevel = fireballLevel;
                gmMode = true;
                gmButton.classList.add('active');
                gmStatus.textContent = 'ON';
                
                invincibleTime = 999999;
                powerUpTime = 999999;
                fireballLevel = MAX_FIREBALL_LEVEL;
                fireballDamage = MAX_FIREBALL_LEVEL;
                superLaserActive = true;
                superLaserDuration = 999999;
                superLaserWidth = canvas.width;
                superLaserReady = true;
                laserActive = true;
                superLaserHeight = canvas.height;
                laserCharge = 100;
                laserCooldown = 0;
                scoreMultiplier = 999;
                
                document.getElementById('superLaserCharge').style.display = 'block';
                document.getElementById('superLaserChargeBar').style.width = '100%';
                document.getElementById('superLaserChargeText').textContent = 'GMÊ®°Âºè';
            } else {
                gmMode = false;
                gmButton.classList.remove('active');
                gmStatus.textContent = 'OFF';
                
                fireballLevel = preGMLevel;
                fireballDamage = preGMLevel;
                invincibleTime = 0;
                powerUpTime = 0;
                superLaserActive = false;
                superLaserDuration = 0;
                superLaserChargeProgress = 0;
                superLaserWidth = 20;
                laserActive = false;
                isFiringSuperLaser = false;
                isFiringMiniLaser = false;
                scoreMultiplier = 1;
                
                if (fireballLevel >= 30) {
                    laserActive = true;
                    laserCharge = 100;
                } else if (fireballLevel >= 20) {
                    laserActive = false;
                    laserCharge = 0;
                } else if (fireballLevel >= 10) {
                    laserActive = false;
                    laserCharge = 0;
                }
                
                document.getElementById('superLaserCharge').style.display = 'none';
                document.getElementById('superLaserChargeBar').style.width = '0%';
                document.getElementById('superLaserChargeText').textContent = 'Ë∂ÖÁ∫ßÊøÄÂÖâÂÖÖËÉΩ: 0%';
            }
        }
        window.toggleGM = toggleGM;
        
        // ===============================
        // ÈöæÂ∫¶Á≥ªÁªüÂáΩÊï∞
        // ===============================
        
        // Ëé∑ÂèñÂàÜÊï∞ÂÄçÊï∞ÔºàÊ†πÊçÆÊ®°ÂºèË∞ÉÊï¥Ôºâ
        function getScoreMultiplier() {
            if (hellMode) return 1; // Âú∞Áã±Ê®°ÂºèÔºöÊÅ¢Â§çÂà∞ÂéüÊù•ÁöÑÂàÜÊï∞Ëé∑ÂèñÈÄüÂ∫¶
            if (nightmareMode) return 1/3; // Âô©Ê¢¶Ê®°ÂºèÔºöÂàÜÊï∞Ëé∑ÂèñÂèò‰∏∫ÂéüÊù•ÁöÑ1/3
            if (hardMode) return 0.5; // Âõ∞ÈöæÊ®°ÂºèÔºöÂàÜÊï∞Ëé∑ÂèñÂØπÂçäÂáèÂ∞ë
            return 1; // ÊôÆÈÄöÊ®°Âºè
        }
        
        // Ëé∑ÂèñÂ¢ûÁõäÂÄçÊï∞ÔºàÊ†πÊçÆÊ®°ÂºèË∞ÉÊï¥Ôºâ
        function getBuffMultiplier(isLightningSkill = false) {
            if (hellMode) return 1/3; // Âú∞Áã±Ê®°ÂºèÔºöÊâÄÊúâÂ¢ûÁõäbuffÂáèÂ∞ëÂà∞1/3
            if (nightmareMode) {
                if (isLightningSkill) {
                    return 1; // Âô©Ê¢¶Ê®°ÂºèÔºöÈó™ÁîµÊäÄËÉΩÁöÑÂ¢ûÁõäbuff‰∏çË¢´ÂáèÂ∞ë
                }
                return 0.5; // Âô©Ê¢¶Ê®°ÂºèÔºöÂÖ∂‰ªñÂ¢ûÁõäbuffÂØπÂçäÂáèÂ∞ë
            }
            return 1; // ÊôÆÈÄöÊ®°ÂºèÂíåÂõ∞ÈöæÊ®°ÂºèÔºö‰∏çÂáèÂ∞ëÂ¢ûÁõäbuff
        }
        
        // Êõ¥Êñ∞Âõ∞ÈöæÊ®°ÂºèÂÄçÊï∞ÔºàÊåáÊï∞Á∫ßÂ¢ûÈïøÔºâ
        function updateHardModeMultiplier() {
            if (hellMode) {
                // Âú∞Áã±Ê®°ÂºèÔºö‰ªé32ÂÄçÂºÄÂßãÔºåÊØè5000ÂàÜ‰πò‰ª•32
                const scoreSegments = Math.floor((score - hellModeStartScore) / 5000);
                hardModeMultiplier = 32 * Math.pow(32, scoreSegments);
            } else if (nightmareMode) {
                // Âô©Ê¢¶Ê®°ÂºèÔºö‰ªé16ÂÄçÂºÄÂßãÔºåÊØè5000ÂàÜ‰πò‰ª•16
                const scoreSegments = Math.floor((score - nightmareModeStartScore) / 5000);
                hardModeMultiplier = 16 * Math.pow(16, scoreSegments);
            } else if (hardMode) {
                // Âõ∞ÈöæÊ®°ÂºèÔºö‰ªé3ÂÄçÂºÄÂßãÔºåÊØè5000ÂàÜ‰πò‰ª•3
                const scoreSegments = Math.floor((score - hardModeStartScore) / 5000);
                hardModeMultiplier = 3 * Math.pow(3, scoreSegments);
            }
        }
        
        // ÊøÄÊ¥ªÈó™ÁîµÊäÄËÉΩÔºà60Á∫ßÂçáÁ∫ßÁâàÔºâ
        function activateLightningSkill() {
            if (lightningSkillCooldown <= 0 && !lightningSkillActive && fireballLevel >= 40) {
                lightningSkillActive = true;
                // Â∫îÁî®Ê®°ÂºèÁâπÂÆöÁöÑÂ¢ûÁõäÂÄçÊï∞
                let buffMult = getBuffMultiplier(true); // Èó™ÁîµÊäÄËÉΩÁöÑbuff
                lightningSkillDuration = 30 * 60 * passiveBuffMultiplier * buffMult;
                lightningSkillCooldown = 15 * 60;
                
                lightningSkillOriginalDarkMode = isDarkMode;
                lightningSkillOriginalTransition = themeTransition;
                
                targetDarkMode = true;
                themeTransition = 1;
                isDarkMode = true;
                
                rainParticles = [];
                for (let i = 0; i < 20; i++) {
                    rainParticles.push(new RainParticle());
                }
                
                if (fireballLevel >= 60) {
                    lightningSkillUpgraded = true;
                    healOverTime = 30 * 60 * passiveBuffMultiplier * buffMult;
                    healOverTimeTimer = 0;
                    createFloatingText("‚ö° Èó™ÁîµÊäÄËÉΩÂçáÁ∫ßÔºÅ30ÁßíÁîüÂëΩÊÅ¢Â§ç", dino.x, dino.y - 50, '#00ccff', 120);
                } else {
                    lightningSkillUpgraded = false;
                }
            }
        }
        
        // ÁªìÊùüÈó™ÁîµÊäÄËÉΩ
        function endLightningSkill() {
            lightningSkillActive = false;
            
            isDarkMode = lightningSkillOriginalDarkMode;
            themeTransition = lightningSkillOriginalTransition;
            targetDarkMode = lightningSkillOriginalDarkMode;
            themeTimer = 0;
            
            rainParticles = [];
        }
        
        // ÁÅ´ÁêÉÁ±ª
        class Fireball {
            constructor(x, y, isEnemy = false, enemyLevel = 1, isSuperLaser = false, isLaser = false) {
                this.x = x;
                this.y = y;
                this.isEnemy = isEnemy;
                this.isLaser = isLaser;
                this.isSuperLaser = isSuperLaser;
                
                if (isEnemy) {
                    this.width = 20;
                    this.height = 12;
                } else if (isSuperLaser) {
                    this.width = 1;
                    this.height = 1;
                } else if (this.isLaser) {
                    this.width = 40;
                    this.height = 8;
                } else {
                    this.width = 20;
                    this.height = 12;
                }
                
                this.speed = isEnemy ? -12 : 12;
                
                if (isEnemy) {
                    this.penetration = 3 * hardModeMultiplier;
                    let baseDamage = Math.ceil(enemyLevel / 5) * hardModeMultiplier;
                    if (score >= 3000) {
                        baseDamage = 10 * hardModeMultiplier;
                        const extraDamage = Math.floor((score - 3000) / 100) * hardModeMultiplier;
                        this.damage = baseDamage + extraDamage;
                    } else {
                        this.damage = baseDamage;
                    }
                    
                    this.damage *= 2;
                    
                    if (powerUpTime > 0) {
                        this.damage *= 2;
                    }
                } else {
                    if (hasInfinitePenetration) {
                        this.penetration = 999999;
                    } else if (powerUpTime > 0) {
                        this.penetration = fireballDamage * 3;
                    } else {
                        this.penetration = fireballDamage;
                    }
                    
                    if (this.isSuperLaser) {
                        this.penetration *= 10;
                    }
                    
                    this.damage = fireballDamage * scoreMultiplier * passiveScoreMultiplier;
                    if (powerUpTime > 0) {
                        this.damage *= 2;
                    }
                    if (fireballLevel >= 10) {
                        this.damage *= 2;
                    }
                }
                
                this.hit = 0;
            }
            
            update() {
                if (!this.isSuperLaser) {
                    this.x += this.speed;
                }
                
                if (frameCount % 8 === 0 && !this.isSuperLaser) {
                    let color;
                    if (this.isEnemy) {
                        color = '#f97316';
                    } else if (this.isLaser) {
                        color = '#00ff00';
                    } else {
                        color = powerUpTime > 0 ? '#4dabf7' : '#ff6b6b';
                    }
                    particles.push(new Particle(this.x, this.y + this.height/2, color));
                }
            }
            
            draw() {
                let mainColor, coreColor;
                
                if (this.isEnemy) {
                    mainColor = '#f97316';
                    coreColor = '#fde68a';
                } else if (this.isSuperLaser) {
                    return;
                } else if (this.isLaser) {
                    mainColor = '#00ff00';
                    coreColor = '#ffffff';
                } else {
                    mainColor = powerUpTime > 0 ? '#4dabf7' : '#ff6b6b';
                    coreColor = powerUpTime > 0 ? '#74c0fc' : '#ffd93d';
                }
                
                ctx.fillStyle = mainColor;
                
                if (this.isLaser) {
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = mainColor;
                    ctx.fillRect(this.x, this.y, this.width, this.height);
                    ctx.shadowBlur = 0;
                } else {
                    ctx.beginPath();
                    ctx.ellipse(this.x + 10, this.y + 6, 10, 6, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.beginPath();
                    const tipX = this.isEnemy ? this.x - 8 : this.x + 20;
                    const tip1X = this.isEnemy ? this.x : this.x + 28;
                    ctx.moveTo(tipX, this.y + 6);
                    ctx.lineTo(tip1X, this.y + 2);
                    ctx.lineTo(tip1X, this.y + 10);
                    ctx.closePath();
                    ctx.fill();
                }
                
                if (!this.isSuperLaser) {
                    ctx.fillStyle = coreColor;
                    ctx.beginPath();
                    ctx.ellipse(this.x + 10, this.y + 6, 5, 3, 0, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            isOffScreen() {
                if (this.isSuperLaser) return false;
                if (hasInfinitePenetration && !this.isEnemy) {
                    return this.x > canvas.width + 100 || this.x < -100;
                }
                return this.x > canvas.width + 50 || this.x < -50 || this.hit >= this.penetration;
            }
            
            getHitbox() {
                return {
                    x: this.x,
                    y: this.y,
                    width: this.width,
                    height: this.height
                };
            }
        }
        
        // ÈÅìÂÖ∑Á±ª - ‰øÆÊîπÊ¶ÇÁéáÂíåÊïàÊûú
        class PowerUp {
            constructor(type = null) {
                this.x = canvas.width;
                const maxHeight = canvas.height * 0.6;
                const minHeight = canvas.height - 120;
                this.y = Math.random() * (maxHeight - minHeight) + minHeight;
                this.width = 16;
                this.height = 16;
                
                if (!type) {
                    const rand = Math.random();
                    if (rand < 0.7) {
                        const typeRand = Math.random();
                        if (typeRand < 0.25) this.type = 'life';
                        else if (typeRand < 0.35) this.type = 'barrier';
                        else if (typeRand < 0.45) this.type = 'invincible';
                        else if (typeRand < 0.60) this.type = 'powerup';
                        else if (typeRand < 0.65) this.type = 'ultimate';
                        else if (typeRand < 0.73) this.type = 'triColor';
                        else if (typeRand < 0.78) this.type = 'rainbow';
                        else this.type = 'score';
                    } else {
                        this.type = 'none';
                    }
                } else {
                    this.type = type;
                }
                
                this.angle = 0;
            }
            
            update() {
                this.x -= 2.4;
                this.angle += 0.1;
            }
            
            draw() {
                if (this.type === 'none') return;
                
                const colors = {
                    'invincible': '#ff6b6b',
                    'powerup': '#4dabf7',
                    'life': '#51cf66',
                    'barrier': '#ffffff',
                    'ultimate': '#ffd700',
                    'rainbow': 'rainbow',
                    'triColor': 'triColor',
                    'score': '#ffff00',
                };
                
                const color = colors[this.type];
                const size = (this.type === 'ultimate' || this.type === 'rainbow' || this.type === 'triColor') ? this.width * 1.5 : this.width;
                
                ctx.save();
                ctx.translate(this.x + this.width/2, this.y + this.height/2);
                ctx.rotate(this.angle);
                
                ctx.shadowBlur = (this.type === 'ultimate' || this.type === 'rainbow' || this.type === 'triColor') ? 25 : 10;
                
                if (this.type === 'triColor') {
                    ctx.fillStyle = '#00ff00';
                    ctx.beginPath();
                    ctx.arc(0, 0, size/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#ff0000';
                    ctx.beginPath();
                    ctx.arc(0, 0, size/2 - 2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#0000ff';
                    ctx.beginPath();
                    ctx.arc(0, 0, size/4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.beginPath();
                    ctx.arc(-size/6, -size/6, size/8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.shadowColor = 'rgba(0, 255, 0, 0.8)';
                } else if (this.type === 'rainbow') {
                    const gradient = ctx.createLinearGradient(-size/2, -size/2, size/2, size/2);
                    gradient.addColorStop(0, '#ff0000');
                    gradient.addColorStop(0.16, '#ff9900');
                    gradient.addColorStop(0.33, '#ffff00');
                    gradient.addColorStop(0.5, '#00ff00');
                    gradient.addColorStop(0.66, '#00ffff');
                    gradient.addColorStop(0.83, '#0000ff');
                    gradient.addColorStop(1, '#9900ff');
                    ctx.fillStyle = gradient;
                    ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
                } else if (this.type === 'ultimate') {
                    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, size/2);
                    gradient.addColorStop(0, '#ffff00');
                    gradient.addColorStop(0.5, '#ffd700');
                    gradient.addColorStop(1, '#ff9900');
                    ctx.fillStyle = gradient;
                    ctx.shadowColor = 'rgba(255, 215, 0, 0.8)';
                } else if (this.type === 'barrier') {
                    ctx.fillStyle = '#ffff00';
                    ctx.beginPath();
                    ctx.arc(0, 0, size/2 + 3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = color;
                    ctx.beginPath();
                    ctx.arc(0, 0, size/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.beginPath();
                    ctx.arc(0, 0, size/4, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowColor = '#ffff00';
                } else {
                    ctx.fillStyle = color;
                    ctx.shadowColor = color;
                }
                
                if (this.type !== 'triColor' && this.type !== 'barrier') {
                    ctx.beginPath();
                    ctx.arc(0, 0, size/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.beginPath();
                    ctx.arc(0, 0, size/4, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                if (this.type === 'ultimate' || this.type === 'rainbow' || this.type === 'triColor') {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(0, 0, size/2 + 3, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                ctx.restore();
            }
            
            isOffScreen() {
                return this.x + this.width < 0;
            }
            
            getHitbox() {
                return {
                    x: this.x,
                    y: this.y,
                    width: this.width,
                    height: this.height
                };
            }
        }
        
        // ÈöúÁ¢çÁâ©Á±ª
        class Obstacle {
            constructor(type) {
                this.type = type;
                this.x = canvas.width;
                
                if (type === 'cactus') {
                    this.width = 16 + Math.random() * 12;
                    this.height = 30 + Math.random() * 20;
                    this.y = canvas.height - 30 - this.height;
                } else if (type === 'bird') {
                    this.width = 46;
                    this.height = 30;
                    this.y = canvas.height - 30 - this.height - 15;
                } else if (type === 'birdBomb') {
                    return new BirdBomb(canvas.width, canvas.height - 30 - 30 - 15);
                }
                
                this.birdFrame = 0;
            }
            
            update() {
                this.x -= gameSpeed;
                
                if (this.type === 'bird' && frameCount % 10 === 0) {
                    this.birdFrame = (this.birdFrame + 1) % 2;
                }
            }
            
            draw() {
                ctx.fillStyle = isDarkMode ? '#f0f0f0' : '#535353';
                
                if (this.type === 'cactus') {
                    this.drawCactus();
                } else if (this.type === 'bird') {
                    this.drawBird();
                }
            }
            
            drawCactus() {
                const scale = this.width / 20;
                const baseX = this.x;
                const baseY = this.y;
                
                ctx.fillRect(baseX + 6 * scale, baseY, 8 * scale, this.height);
                
                if (this.width > 20) {
                    ctx.fillRect(baseX, baseY + this.height * 0.3, 6 * scale, this.height * 0.4);
                    ctx.fillRect(baseX + 6 * scale, baseY + this.height * 0.3, 2 * scale, this.height * 0.15);
                }
                
                if (this.width > 18) {
                    ctx.fillRect(baseX + 14 * scale, baseY + this.height * 0.4, 6 * scale, this.height * 0.35);
                    ctx.fillRect(baseX + 12 * scale, baseY + this.height * 0.4, 2 * scale, this.height * 0.15);
                }
            }
            
            drawBird() {
                const y = this.y;
                
                ctx.save();
                ctx.scale(-1, 1);
                ctx.translate(-this.x * 2 - this.width, 0);
                
                ctx.fillRect(this.x + 10, y + 10, 26, 10);
                
                ctx.fillRect(this.x + 30, y + 6, 10, 8);
                ctx.fillRect(this.x + 40, y + 8, 4, 4);
                
                ctx.fillRect(this.x + 36, y + 8, 2, 2);
                
                if (this.birdFrame === 0) {
                    ctx.fillRect(this.x + 14, y, 16, 8);
                } else {
                    ctx.fillRect(this.x + 14, y + 12, 16, 8);
                }
                
                ctx.fillRect(this.x, y + 12, 10, 6);
                
                ctx.restore();
            }
            
            getHitbox() {
                if (this.type === 'cactus') {
                    return {
                        x: this.x + 2,
                        y: this.y,
                        width: this.width - 4,
                        height: this.height
                    };
                } else if (this.type === 'bird') {
                    return {
                        x: this.x + 10,
                        y: this.y + 6,
                        width: 34,
                        height: 18
                    };
                }
                return null;
            }
            
            isOffScreen() {
                return this.x + this.width < 0;
            }
        }
        
        // ‰∫ëÊúµÁ±ª
        class Cloud {
            constructor() {
                this.x = canvas.width;
                this.y = Math.random() * 60 + 20;
                this.width = 46;
                this.height = 14;
            }
            
            update() {
                this.x -= gameSpeed * 0.3;
            }
            
            draw() {
                ctx.fillStyle = isDarkMode ? '#4a4a4a' : '#d3d3d3';
                ctx.fillRect(this.x, this.y, 22, 6);
                ctx.fillRect(this.x + 6, this.y - 4, 16, 4);
                ctx.fillRect(this.x + 10, this.y + 6, 14, 4);
                ctx.fillRect(this.x + 22, this.y, 12, 10);
                ctx.fillRect(this.x + 34, this.y + 2, 12, 6);
            }
            
            isOffScreen() {
                return this.x + this.width < 0;
            }
        }
        
        // ÊÅêÈæôÂØπË±°
        const GRAVITY = 0.6;
        
        const dino = {
            x: 100,
            y: 0,
            width: 44,
            height: 47,
            dy: 0,
            jumpPower: -12,
            grounded: false,
            ducking: false,
            
            runFrame: 0,
            runSpeed: 5,
            
            jump() {
                if (this.grounded) {
                    this.dy = this.jumpPower;
                    this.grounded = false;
                }
            },
            
            duck(isDucking) {
                this.ducking = isDucking;
            },
            
            update() {
                this.dy += GRAVITY;
                this.y += this.dy;
                
                const groundY = canvas.height - 30 - this.height;
                if (this.y >= groundY) {
                    this.y = groundY;
                    this.dy = 0;
                    this.grounded = true;
                }
            },
            
            draw() {
                if (barrierCount > 0) {
                    ctx.save();
                    const barrierAlpha = 0.3 + (Math.sin(barrierFlash * 0.1) * 0.2);
                    ctx.strokeStyle = `rgba(255, 255, 255, ${barrierAlpha})`;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    const radius = Math.max(this.width, this.height) / 2 + 10;
                    ctx.arc(this.x + this.width/2, this.y + this.height/2, radius, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    ctx.fillStyle = '#800080';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(`Â±èÈöú: ${barrierCount}`, this.x + this.width/2, this.y - 5);
                    ctx.restore();
                    
                    barrierFlash++;
                }
                
                if (invulnerableFlash > 0 && Math.floor(invulnerableFlash / 10) % 2 === 0) {
                    return;
                }
                
                if (gmMode || invincibleTime > 0) {
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#ff6b6b';
                }
                
                ctx.fillStyle = isDarkMode ? '#f0f0f0' : '#535353';
                
                if (this.ducking && this.grounded) {
                    this.drawDucking();
                } else {
                    this.drawRunning();
                }
                
                ctx.shadowBlur = 0;
            },
            
            drawRunning() {
                const headY = this.y;
                const bodyY = this.y + 20;
                
                ctx.fillRect(this.x + 18, headY, 16, 12);
                ctx.fillRect(this.x + 34, headY + 6, 4, 6);
                ctx.fillRect(this.x + 16, headY + 12, 18, 10);
                
                ctx.fillRect(this.x + 30, headY + 6, 2, 3);
                
                ctx.fillRect(this.x + 16, bodyY + 2, 22, 16);
                
                ctx.fillRect(this.x + 6, bodyY + 4, 10, 4);
                ctx.fillRect(this.x + 4, bodyY, 2, 4);
                
                ctx.fillRect(this.x + 30, bodyY + 10, 6, 2);
                
                if (this.grounded) {
                    if (frameCount % 10 < 5) {
                        ctx.fillRect(this.x + 18, bodyY + 18, 4, 8);
                        ctx.fillRect(this.x + 18, bodyY + 26, 6, 2);
                        ctx.fillRect(this.x + 28, bodyY + 18, 4, 6);
                    } else {
                        ctx.fillRect(this.x + 18, bodyY + 18, 4, 6);
                        ctx.fillRect(this.x + 28, bodyY + 18, 4, 8);
                        ctx.fillRect(this.x + 28, bodyY + 26, 6, 2);
                    }
                } else {
                    ctx.fillRect(this.x + 18, bodyY + 18, 4, 6);
                    ctx.fillRect(this.x + 28, bodyY + 18, 4, 6);
                }
            },
            
            drawDucking() {
                const baseY = this.y + 20;
                
                ctx.fillRect(this.x + 24, baseY, 16, 12);
                ctx.fillRect(this.x + 40, baseY + 6, 4, 6);
                
                ctx.fillRect(this.x + 36, baseY + 6, 2, 3);
                
                ctx.fillRect(this.x + 10, baseY + 6, 30, 12);
                
                ctx.fillRect(this.x, baseY + 8, 10, 4);
                
                ctx.fillRect(this.x + 14, baseY + 18, 4, 6);
                ctx.fillRect(this.x + 24, baseY + 18, 4, 6);
            },
            
            getHitbox() {
                if (this.ducking && this.grounded) {
                    return {
                        x: this.x + 10,
                        y: this.y + 20,
                        width: 34,
                        height: 24
                    };
                }
                return {
                    x: this.x + 16,
                    y: this.y,
                    width: 22,
                    height: 47
                };
            }
        };
        
        // ÁªòÂà∂Âú∞Èù¢
        function drawGround() {
            const groundY = canvas.height - 30;
            ctx.strokeStyle = isDarkMode ? '#f0f0f0' : '#535353';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, groundY);
            ctx.lineTo(canvas.width, groundY);
            ctx.stroke();
            
            ctx.fillStyle = isDarkMode ? '#f0f0f0' : '#535353';
            for (let i = 0; i < canvas.width; i += 20) {
                const offset = (frameCount * gameSpeed / 5) % 20;
                const x = i - offset;
                if (x >= -10 && x <= canvas.width) {
                    ctx.fillRect(x, groundY + 2, 4, 2);
                }
            }
        }
        
        // Êõ¥Êñ∞Ë∂ÖÁ∫ßÊøÄÂÖâ
        function updateSuperLaser() {
            if (fireballLevel >= 50 && !gmMode) {
                document.getElementById('superLaserCharge').style.display = 'block';
                
                if (!superLaserActive && superLaserChargeProgress < superLaserChargeTime) {
                    superLaserChargeProgress += 1/60;
                    const percent = (superLaserChargeProgress / superLaserChargeTime) * 100;
                    document.getElementById('superLaserChargeBar').style.width = percent + '%';
                    document.getElementById('superLaserChargeText').textContent = 
                        `Ë∂ÖÁ∫ßÊøÄÂÖâÂÖÖËÉΩ: ${Math.ceil(percent)}%`;
                    
                    if (superLaserChargeProgress >= superLaserChargeTime) {
                        superLaserReady = true;
                        superLaserActive = true;
                        superLaserDuration = superLaserDurationTime;
                        superLaserWidth = 20;
                        superLaserExpanding = false;
                        superLaserExpandSpeed = 0.2;
                    }
                }
                
                if (superLaserActive) {
                    if (isFiringSuperLaser) {
                        if (superLaserWidth < canvas.width) {
                            superLaserWidth += superLaserExpandSpeed;
                            superLaserExpandSpeed += superLaserExpandAcceleration;
                            superLaserWidth = Math.min(canvas.width, superLaserWidth);
                        }
                        
                        if (frameCount % 3 === 0) {
                            const laserHitbox = {
                                x: dino.x + dino.width,
                                y: 0,
                                width: superLaserWidth,
                                height: superLaserHeight
                            };
                            
                            if (superLaserInstantKill) {
                                for (let i = obstacles.length - 1; i >= 0; i--) {
                                    const obstacle = obstacles[i];
                                    const obstacleHitbox = obstacle.getHitbox();
                                    
                                    if (checkCollision(laserHitbox, obstacleHitbox)) {
                                        createExplosion(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                                        obstacles.splice(i, 1);
                                        score += 5 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                                    }
                                }
                                
                                for (let i = enemies.length - 1; i >= 0; i--) {
                                    const enemy = enemies[i];
                                    const enemyHitbox = enemy.getHitbox();
                                    
                                    if (checkCollision(laserHitbox, enemyHitbox)) {
                                        createExplosion(enemy.x, enemy.y, enemy.width, enemy.height);
                                        enemies.splice(i, 1);
                                        score += enemy.level * 10 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                                        
                                        if (lightningSkillActive && frameCount - lastLightningTime > 30 && Math.random() > 0.7) {
                                            lightningBolts.push(new LightningBolt(enemy.x, enemy.y));
                                            lastLightningTime = frameCount;
                                        }
                                    }
                                }
                                
                                for (let i = enemyFireballs.length - 1; i >= 0; i--) {
                                    const fireball = enemyFireballs[i];
                                    const fireballHitbox = fireball.getHitbox();
                                    
                                    if (checkCollision(laserHitbox, fireballHitbox)) {
                                        createExplosion(fireball.x, fireball.y, fireball.width, fireball.height);
                                        enemyFireballs.splice(i, 1);
                                    }
                                }
                                
                                for (let i = trucks.length - 1; i >= 0; i--) {
                                    const truck = trucks[i];
                                    const truckHitbox = truck.getHitbox();
                                    
                                    if (checkCollision(laserHitbox, truckHitbox)) {
                                        triggerGlobalExplosion(truck.x, truck.y, 15);
                                        trucks.splice(i, 1);
                                        score += 100 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                                    }
                                }
                                
                                for (let i = birdBombs.length - 1; i >= 0; i--) {
                                    const bird = birdBombs[i];
                                    if (!bird.isExploded) {
                                        const birdHitbox = bird.getHitbox();
                                        
                                        if (checkCollision(laserHitbox, birdHitbox)) {
                                            bird.explode(true);
                                            birdBombs.splice(i, 1);
                                        }
                                    }
                                }
                                
                                for (let i = bombPlanes.length - 1; i >= 0; i--) {
                                    const plane = bombPlanes[i];
                                    if (!plane.isExploded) {
                                        const planeHitbox = plane.getHitbox();
                                        
                                        if (checkCollision(laserHitbox, planeHitbox)) {
                                            plane.explode();
                                            bombPlanes.splice(i, 1);
                                        }
                                    }
                                }
                                
                                for (let i = bombs.length - 1; i >= 0; i--) {
                                    const bomb = bombs[i];
                                    if (!bomb.isExploded) {
                                        const bombHitbox = bomb.getHitbox();
                                        
                                        if (checkCollision(laserHitbox, bombHitbox)) {
                                            bomb.explode();
                                            bombs.splice(i, 1);
                                        }
                                    }
                                }
                                
                                for (let i = powerUps.length - 1; i >= 0; i--) {
                                    const powerUp = powerUps[i];
                                    const powerUpHitbox = powerUp.getHitbox();
                                    
                                    if (checkCollision(laserHitbox, powerUpHitbox)) {
                                        powerUps.splice(i, 1);
                                    }
                                }
                            } else {
                                const damage = maxLives * superLaserDamageMultiplier;
                                
                                for (let i = obstacles.length - 1; i >= 0; i--) {
                                    const obstacle = obstacles[i];
                                    const obstacleHitbox = obstacle.getHitbox();
                                    
                                    if (checkCollision(laserHitbox, obstacleHitbox)) {
                                        createExplosion(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                                        obstacles.splice(i, 1);
                                        score += 5 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                                    }
                                }
                                
                                for (let i = enemies.length - 1; i >= 0; i--) {
                                    const enemy = enemies[i];
                                    const enemyHitbox = enemy.getHitbox();
                                    
                                    if (checkCollision(laserHitbox, enemyHitbox)) {
                                        const isDead = enemy.takeDamage(damage);
                                        if (isDead) {
                                            createExplosion(enemy.x, enemy.y, enemy.width, enemy.height);
                                            enemies.splice(i, 1);
                                            score += enemy.level * 10 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                                            
                                            if (lightningSkillActive && frameCount - lastLightningTime > 30 && Math.random() > 0.7) {
                                                lightningBolts.push(new LightningBolt(enemy.x, enemy.y));
                                                lastLightningTime = frameCount;
                                            }
                                        }
                                    }
                                }
                                
                                for (let i = enemyFireballs.length - 1; i >= 0; i--) {
                                    const fireball = enemyFireballs[i];
                                    const fireballHitbox = fireball.getHitbox();
                                    
                                    if (checkCollision(laserHitbox, fireballHitbox)) {
                                        createExplosion(fireball.x, fireball.y, fireball.width, fireball.height);
                                        enemyFireballs.splice(i, 1);
                                    }
                                }
                                
                                for (let i = trucks.length - 1; i >= 0; i--) {
                                    const truck = trucks[i];
                                    const truckHitbox = truck.getHitbox();
                                    
                                    if (checkCollision(laserHitbox, truckHitbox)) {
                                        const isDead = truck.takeDamage(damage, true, false);
                                        if (isDead) {
                                            triggerGlobalExplosion(truck.x, truck.y, 15);
                                            trucks.splice(i, 1);
                                            score += 100 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                                        }
                                    }
                                }
                                
                                for (let i = birdBombs.length - 1; i >= 0; i--) {
                                    const bird = birdBombs[i];
                                    if (!bird.isExploded) {
                                        const birdHitbox = bird.getHitbox();
                                        
                                        if (checkCollision(laserHitbox, birdHitbox)) {
                                            bird.explode(true);
                                            birdBombs.splice(i, 1);
                                        }
                                    }
                                }
                                
                                for (let i = bombPlanes.length - 1; i >= 0; i--) {
                                    const plane = bombPlanes[i];
                                    if (!plane.isExploded) {
                                        const planeHitbox = plane.getHitbox();
                                        
                                        if (checkCollision(laserHitbox, planeHitbox)) {
                                            plane.explode();
                                            bombPlanes.splice(i, 1);
                                        }
                                    }
                                }
                                
                                for (let i = bombs.length - 1; i >= 0; i--) {
                                    const bomb = bombs[i];
                                    if (!bomb.isExploded) {
                                        const bombHitbox = bomb.getHitbox();
                                        
                                        if (checkCollision(laserHitbox, bombHitbox)) {
                                            bomb.explode();
                                            bombs.splice(i, 1);
                                        }
                                    }
                                }
                                
                                for (let i = powerUps.length - 1; i >= 0; i--) {
                                    const powerUp = powerUps[i];
                                    const powerUpHitbox = powerUp.getHitbox();
                                    
                                    if (checkCollision(laserHitbox, powerUpHitbox)) {
                                        powerUps.splice(i, 1);
                                    }
                                }
                            }
                        }
                    } else {
                        if (superLaserWidth > 20) {
                            superLaserWidth = Math.max(20, superLaserWidth - 5);
                        }
                        superLaserExpandSpeed = 0.2;
                    }
                    
                    if (isFiringSuperLaser) {
                        superLaserDuration -= 1/60;
                    }
                    
                    if (superLaserDuration <= 0) {
                        superLaserActive = false;
                        superLaserReady = false;
                        superLaserChargeProgress = 0;
                        superLaserWidth = 20;
                        superLaserExpanding = false;
                        superLaserExpandSpeed = 0.2;
                        isFiringSuperLaser = false;
                        document.getElementById('superLaserChargeBar').style.width = '0%';
                        document.getElementById('superLaserChargeText').textContent = 'Ë∂ÖÁ∫ßÊøÄÂÖâÂÖÖËÉΩ: 0%';
                    }
                }
            } else if (gmMode && superLaserActive) {
                document.getElementById('superLaserCharge').style.display = 'block';
                
                if (isFiringSuperLaser) {
                    if (superLaserWidth < canvas.width) {
                        superLaserWidth += 10;
                        superLaserWidth = Math.min(canvas.width, superLaserWidth);
                    }
                    
                    if (frameCount % 3 === 0) {
                        const laserHitbox = {
                            x: dino.x + dino.width,
                            y: 0,
                            width: superLaserWidth,
                            height: superLaserHeight
                        };
                        
                        for (let i = obstacles.length - 1; i >= 0; i--) {
                            const obstacle = obstacles[i];
                            const obstacleHitbox = obstacle.getHitbox();
                            
                            if (checkCollision(laserHitbox, obstacleHitbox)) {
                                createExplosion(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                                obstacles.splice(i, 1);
                                score += 5 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                            }
                        }
                        
                        for (let i = enemies.length - 1; i >= 0; i--) {
                            const enemy = enemies[i];
                            const enemyHitbox = enemy.getHitbox();
                            
                            if (checkCollision(laserHitbox, enemyHitbox)) {
                                createExplosion(enemy.x, enemy.y, enemy.width, enemy.height);
                                enemies.splice(i, 1);
                                score += enemy.level * 10 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                            }
                        }
                        
                        for (let i = enemyFireballs.length - 1; i >= 0; i--) {
                            const fireball = enemyFireballs[i];
                            const fireballHitbox = fireball.getHitbox();
                            
                            if (checkCollision(laserHitbox, fireballHitbox)) {
                                createExplosion(fireball.x, fireball.y, fireball.width, fireball.height);
                                enemyFireballs.splice(i, 1);
                            }
                        }
                        
                        for (let i = trucks.length - 1; i >= 0; i--) {
                            const truck = trucks[i];
                            const truckHitbox = truck.getHitbox();
                            
                            if (checkCollision(laserHitbox, truckHitbox)) {
                                triggerGlobalExplosion(truck.x, truck.y, 15);
                                trucks.splice(i, 1);
                                score += 100 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                            }
                        }
                        
                        for (let i = birdBombs.length - 1; i >= 0; i--) {
                            const bird = birdBombs[i];
                            if (!bird.isExploded) {
                                const birdHitbox = bird.getHitbox();
                                
                                if (checkCollision(laserHitbox, birdHitbox)) {
                                    bird.explode(true);
                                    birdBombs.splice(i, 1);
                                }
                            }
                        }
                        
                        for (let i = bombPlanes.length - 1; i >= 0; i--) {
                            const plane = bombPlanes[i];
                            if (!plane.isExploded) {
                                const planeHitbox = plane.getHitbox();
                                
                                if (checkCollision(laserHitbox, planeHitbox)) {
                                    plane.explode();
                                    bombPlanes.splice(i, 1);
                                }
                            }
                        }
                        
                        for (let i = bombs.length - 1; i >= 0; i--) {
                            const bomb = bombs[i];
                            if (!bomb.isExploded) {
                                const bombHitbox = bomb.getHitbox();
                                
                                if (checkCollision(laserHitbox, bombHitbox)) {
                                    bomb.explode();
                                    bombs.splice(i, 1);
                                }
                            }
                        }
                        
                        for (let i = powerUps.length - 1; i >= 0; i--) {
                            const powerUp = powerUps[i];
                            const powerUpHitbox = powerUp.getHitbox();
                            
                            if (checkCollision(laserHitbox, powerUpHitbox)) {
                                powerUps.splice(i, 1);
                            }
                        }
                    }
                } else {
                    if (superLaserWidth > 20) {
                        superLaserWidth = Math.max(20, superLaserWidth - 5);
                    }
                }
            } else {
                document.getElementById('superLaserCharge').style.display = 'none';
            }
        }
        
        // ÁªòÂà∂Ë∂ÖÁ∫ßÊøÄÂÖâ
        function drawSuperLaser() {
            if (!superLaserActive || gamePaused || !isFiringSuperLaser) return;
            
            const laserX = dino.x + dino.width;
            
            ctx.save();
            
            const gradient = ctx.createLinearGradient(laserX, 0, laserX + superLaserWidth, 0);
            
            const intensity = Math.min(1, superLaserWidth / canvas.width);
            const alpha = 0.3 + intensity * 0.7;
            
            const hue = (frameCount * 2) % 360;
            gradient.addColorStop(0, `hsla(${hue}, 100%, 70%, ${alpha})`);
            gradient.addColorStop(0.2, `hsla(${(hue + 30) % 360}, 100%, 80%, ${alpha})`);
            gradient.addColorStop(0.5, `hsla(${(hue + 60) % 360}, 100%, 90%, ${alpha})`);
            gradient.addColorStop(0.8, `hsla(${(hue + 30) % 360}, 100%, 80%, ${alpha})`);
            gradient.addColorStop(1, `hsla(${hue}, 100%, 70%, ${alpha})`);
            
            ctx.fillStyle = gradient;
            ctx.fillRect(laserX, 0, superLaserWidth, superLaserHeight);
            
            ctx.shadowBlur = 30;
            ctx.shadowColor = `hsl(${hue}, 100%, 70%)`;
            ctx.globalCompositeOperation = 'lighter';
            
            const coreGradient = ctx.createLinearGradient(laserX, 0, laserX + superLaserWidth, 0);
            coreGradient.addColorStop(0, `hsla(${hue}, 100%, 90%, 0.8)`);
            coreGradient.addColorStop(1, `hsla(${(hue + 60) % 360}, 100%, 90%, 0.8)`);
            
            ctx.fillStyle = coreGradient;
            const coreWidth = superLaserWidth * 0.7;
            ctx.fillRect(laserX + (superLaserWidth - coreWidth) / 2, 0, coreWidth, superLaserHeight);
            
            if (frameCount % 10 < 5) {
                const pulseSize = 5 + Math.sin(frameCount * 0.2) * 3;
                ctx.shadowBlur = 50;
                ctx.shadowColor = `hsl(${hue}, 100%, 90%)`;
                ctx.fillStyle = `hsla(${hue}, 100%, 90%, 0.3)`;
                ctx.fillRect(laserX - pulseSize/2, 0, superLaserWidth + pulseSize, superLaserHeight);
            }
            
            ctx.restore();
            
            if (frameCount % 8 === 0) {
                for (let i = 0; i < 2; i++) {
                    const waveX = laserX + Math.random() * superLaserWidth;
                    const waveY = Math.random() * superLaserHeight;
                    
                    ctx.beginPath();
                    ctx.arc(waveX, waveY, 10, 0, Math.PI * 2);
                    ctx.fillStyle = `hsla(${hue}, 100%, 90%, 0.5)`;
                    ctx.fill();
                }
            }
        }
        
        // ÁªòÂà∂Â§©Ê∞îÊïàÊûú
        function drawWeatherEffects() {
            for (const rain of rainParticles) {
                rain.draw();
            }
            
            for (const snow of snowParticles) {
                snow.draw();
            }
            
            for (let i = lightningBolts.length - 1; i >= 0; i--) {
                const lightning = lightningBolts[i];
                lightning.draw();
                
                if (lightning.isDead()) {
                    lightningBolts.splice(i, 1);
                }
            }
            
            if (lightningSkillActive && frameCount % 180 === 0 && Math.random() > 0.7) {
                if (lightningBolts.length < 2) {
                    const lightningX = Math.random() * canvas.width;
                    lightningBolts.push(new LightningBolt(lightningX, canvas.height - 50));
                    
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            }
        }
        
        // ÁªòÂà∂ÁàÜÁÇ∏ÊïàÊûú
        function drawExplosionEffects() {
            for (let i = explosionParticles.length - 1; i >= 0; i--) {
                const particle = explosionParticles[i];
                
                ctx.globalAlpha = particle.life / particle.maxLife;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                ctx.fill();
                
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.vy += 0.2;
                particle.life--;
                
                if (particle.life <= 0) {
                    explosionParticles.splice(i, 1);
                }
            }
            ctx.globalAlpha = 1;
            
            for (let i = explosionEffects.length - 1; i >= 0; i--) {
                const effect = explosionEffects[i];
                
                ctx.globalAlpha = effect.alpha * (effect.life / 10);
                ctx.fillStyle = 'rgba(255, 100, 100, 0.8)';
                ctx.fillRect(effect.x, effect.y, effect.width, effect.height);
                
                effect.life--;
                
                if (effect.life <= 0) {
                    explosionEffects.splice(i, 1);
                }
            }
            ctx.globalAlpha = 1;
        }
        
        // ÁªòÂà∂ÂàÜÊï∞ÂíåÁä∂ÊÄÅ
        function drawScore() {
            ctx.fillStyle = isDarkMode ? '#f0f0f0' : '#535353';
            ctx.font = '16px monospace';
            ctx.textAlign = 'right';
            
            const displayScore = Math.floor(score).toString().padStart(5, '0');
            ctx.fillText(displayScore, canvas.width - 10, 30);
            
            if (highScore > 0) {
                ctx.fillText('HI ' + Math.floor(highScore).toString().padStart(5, '0'), canvas.width - 90, 30);
            }
            
            ctx.font = '14px monospace';
            ctx.textAlign = 'right';
            ctx.fillStyle = lives <= 2 ? '#ef4444' : (isDarkMode ? '#f0f0f0' : '#535353');
            ctx.fillText(`ÁîüÂëΩ: ${lives}/${maxLives}`, canvas.width - 10, 55);
            
            ctx.fillStyle = isDarkMode ? '#f0f0f0' : '#535353';
            ctx.font = '12px monospace';
            
            ctx.fillText(`ÁÅ´ÁÑ∞Á≠âÁ∫ß: ${fireballLevel}`, canvas.width - 120, 80);
            ctx.fillText(`ÂΩìÂâç‰º§ÂÆ≥: ${fireballDamage}`, canvas.width - 120, 100);
            
            const minutes = Math.floor(gameTime / 60);
            const seconds = Math.floor(gameTime % 60);
            ctx.fillText(`Êó∂Èó¥: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`, canvas.width - 10, 105);
            
            let buffY = 50;
            ctx.textAlign = 'left';
            
            if (invincibleTime > 0) {
                ctx.fillStyle = '#ff6b6b';
                ctx.fillText(`Êó†Êïå: ${Math.ceil(invincibleTime)}s`, 10, buffY);
                buffY += 18;
            }
            
            if (powerUpTime > 0) {
                ctx.fillStyle = '#4dabf7';
                ctx.fillText(`ÁÅ´ÁÑ∞Âº∫Âåñ: ${Math.ceil(powerUpTime)}s`, 10, buffY);
                buffY += 18;
            }
            
            if (infinitePenetrationTime > 0) {
                ctx.fillStyle = '#ffd700';
                ctx.fillText(`Êó†ÈôêÁ©øÈÄè: ${Math.ceil(infinitePenetrationTime)}s`, 10, buffY);
                buffY += 18;
            }
            
            if (barrierCount > 0) {
                ctx.fillStyle = '#ffffff';
                ctx.fillText(`Â±èÈöú: ${barrierCount}Ê¨°`, 10, buffY);
                buffY += 18;
            }
            
            if (scoreMultiplier > 1) {
                ctx.fillStyle = '#ffff00';
                ctx.fillText(`ÂàÜÊï∞ÂÄçÁéá: x${scoreMultiplier}`, 10, buffY);
                buffY += 18;
            }
            
            if (healOverTime > 0) {
                ctx.fillStyle = '#00ff00';
                ctx.fillText(`ÊåÅÁª≠Ê≤ªÁñó: ${Math.ceil(healOverTime/60)}s`, 10, buffY);
                buffY += 18;
            }
            
            if (fireballLevel >= 10 && fireballLevel < 20) {
                if (laserActive) {
                    ctx.fillStyle = '#00ff00';
                    ctx.fillText(`Âº∫ÂåñÁÅ´ÁÑ∞ÊøÄÊ¥ª: ${Math.ceil(laserDuration)}s`, 10, buffY);
                    buffY += 18;
                } else if (laserCooldown > 0) {
                    ctx.fillStyle = '#ff6b6b';
                    ctx.fillText(`Âº∫ÂåñÁÅ´ÁÑ∞ÂÜ∑Âç¥: ${Math.ceil(laserCooldown)}s`, 10, buffY);
                    buffY += 18;
                }
            } else if (fireballLevel >= 20 && fireballLevel < 30) {
                if (laserActive) {
                    ctx.fillStyle = '#00ff00';
                    ctx.fillText(`Â∞èÊøÄÂÖâ: ${Math.ceil(laserDuration)}s`, 10, buffY);
                    buffY += 18;
                } else if (laserCooldown > 0) {
                    ctx.fillStyle = '#ff6b6b';
                    ctx.fillText(`Â∞èÊøÄÂÖâÂÜ∑Âç¥: ${Math.ceil(laserCooldown)}s`, 10, buffY);
                    buffY += 18;
                }
            } else if (fireballLevel >= 30) {
                ctx.fillStyle = '#00ff00';
                ctx.fillText(`Êó†ÈôêÂ∞èÊøÄÂÖâ`, 10, buffY);
                buffY += 18;
            }
            
            if (fireballLevel >= 50) {
                if (superLaserActive) {
                    ctx.fillStyle = '#00ffff';
                    if (gmMode) {
                        ctx.fillText(`GMË∂ÖÁ∫ßÊøÄÂÖâ`, 10, buffY);
                    } else {
                        ctx.fillText(`Ë∂ÖÁ∫ßÊøÄÂÖâ: ${Math.ceil(superLaserDuration)}s`, 10, buffY);
                    }
                    buffY += 18;
                } else if (superLaserChargeProgress > 0) {
                    ctx.fillStyle = '#ff00ff';
                    const percent = Math.ceil((superLaserChargeProgress / superLaserChargeTime) * 100);
                    ctx.fillText(`Ë∂ÖÁ∫ßÊøÄÂÖâÂÖÖËÉΩ: ${percent}%`, 10, buffY);
                    buffY += 18;
                }
            }
            
            if (lightningSkillActive) {
                ctx.fillStyle = '#00ccff';
                if (lightningSkillUpgraded) {
                    ctx.fillText(`‚ö°ÂçáÁ∫ßÈó™Áîµ: ${Math.ceil(lightningSkillDuration/60)}s`, 10, buffY);
                } else {
                    ctx.fillText(`Èó™ÁîµÊäÄËÉΩ: ${Math.ceil(lightningSkillDuration/60)}s`, 10, buffY);
                }
                buffY += 18;
            } else if (lightningSkillCooldown > 0 && fireballLevel >= 40) {
                ctx.fillStyle = '#888888';
                ctx.fillText(`Èó™ÁîµÂÜ∑Âç¥: ${Math.ceil(lightningSkillCooldown/60)}s`, 10, buffY);
                buffY += 18;
            }
            
            ctx.fillStyle = '#00ccff';
            ctx.fillText(`Â§©Ê∞î: ${
                currentWeather === 'sunny' ? 'Êô¥Â§©' : 
                currentWeather === 'rainy' ? 'Èõ®Â§©' : 
                currentWeather === 'snowy' ? 'Èõ™Â§©' : 'Êú™Áü•'
            }`, 10, buffY);
            buffY += 18;
            
            if (fireballLevel >= 180) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillText(`180Á∫ßË¢´Âä®: Ë∂ÖÁ∫ßÊøÄÂÖâÁßíÊùÄ`, 10, buffY);
                buffY += 18;
            } else if (fireballLevel >= 170) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillText(`170Á∫ßË¢´Âä®: ÁîüÂëΩÊÅ¢Â§çÂº∫Âåñ`, 10, buffY);
                buffY += 18;
            } else if (fireballLevel >= 160) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillText(`160Á∫ßË¢´Âä®: ÊØè200ÂàÜÊÅ¢Â§ç300ÁîüÂëΩ`, 10, buffY);
                buffY += 18;
            } else if (fireballLevel >= 150) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillText(`150Á∫ßË¢´Âä®: Ë∂ÖÁ∫ßÊøÄÂÖâÂº∫Âåñ`, 10, buffY);
                buffY += 18;
            } else if (fireballLevel >= 140) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillText(`140Á∫ßË¢´Âä®: ÂÖçÁñ´ÁÇ∏Âºπ‰º§ÂÆ≥`, 10, buffY);
                buffY += 18;
            } else if (fireballLevel >= 130) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillText(`130Á∫ßË¢´Âä®: ÂÖçÁñ´ÁÅ´ÁêÉ‰º§ÂÆ≥`, 10, buffY);
                buffY += 18;
            } else if (fireballLevel >= 120) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillText(`120Á∫ßË¢´Âä®: ÊØè400ÂàÜËé∑ÂæóÂ±èÈöú`, 10, buffY);
                buffY += 18;
            } else if (fireballLevel >= 110) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillText(`110Á∫ßË¢´Âä®: ÊØè500ÂàÜËé∑ÂæóÂ±èÈöú`, 10, buffY);
                buffY += 18;
            } else if (fireballLevel >= 100) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillText(`100Á∫ßË¢´Âä®: ÂÖçÁñ´ÈöúÁ¢çÁâ©`, 10, buffY);
                buffY += 18;
            } else if (fireballLevel >= 90) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillText(`90Á∫ßË¢´Âä®: Â¢ûÁõäÊïàÊûúx2`, 10, buffY);
                buffY += 18;
            } else if (fireballLevel >= 80) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillText(`80Á∫ßË¢´Âä®: ÂàÜÊï∞x2`, 10, buffY);
                buffY += 18;
            } else if (fireballLevel >= 70) {
                ctx.fillStyle = '#ff00ff';
                ctx.fillText(`70Á∫ßË¢´Âä®: ÊØè700ÂàÜËé∑ÂæóÂ±èÈöú`, 10, buffY);
                buffY += 18;
            }
            
            ctx.fillStyle = isDarkMode ? '#f0f0f0' : '#535353';
            ctx.textAlign = 'right';
            ctx.fillText(`Êïå‰∫∫: ${enemies.length}/20`, canvas.width - 10, 130);
            ctx.fillText(`Âç°ËΩ¶: ${trucks.length}`, canvas.width - 10, 150);
            
            if (endlessMode) {
                ctx.fillStyle = '#ffd700';
                ctx.textAlign = 'center';
                ctx.fillText('Êó†Â∞ΩÊ®°Âºè', canvas.width / 2, 30);
                ctx.textAlign = 'right';
            }
            
            if (hellMode) {
                ctx.fillStyle = '#8b0000';
                ctx.textAlign = 'center';
                ctx.fillText(`Âú∞Áã±Ê®°Âºè x${hardModeMultiplier.toFixed(1)}`, canvas.width / 2, 60);
                ctx.textAlign = 'right';
            } else if (nightmareMode) {
                ctx.fillStyle = '#8b0000';
                ctx.textAlign = 'center';
                ctx.fillText(`Âô©Ê¢¶Ê®°Âºè x${hardModeMultiplier.toFixed(1)}`, canvas.width / 2, 60);
                ctx.textAlign = 'right';
            } else if (hardMode) {
                ctx.fillStyle = '#ff0000';
                ctx.textAlign = 'center';
                ctx.fillText(`Âõ∞ÈöæÊ®°Âºè x${hardModeMultiplier.toFixed(1)}`, canvas.width / 2, 60);
                ctx.textAlign = 'right';
            }
        }
        
        // ÁªòÂà∂Ê∏∏ÊàèÁªìÊùüÁîªÈù¢
        function drawGameOver() {
            ctx.fillStyle = isDarkMode ? '#f0f0f0' : '#535353';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('G A M E  O V E R', canvas.width / 2, 50);
            
            ctx.fillRect(canvas.width / 2 - 18, 65, 36, 32);
            ctx.fillStyle = isDarkMode ? '#1a1a1a' : '#fff';
            
            ctx.beginPath();
            ctx.arc(canvas.width / 2, 81, 10, 0.5, Math.PI * 1.5);
            ctx.lineWidth = 3;
            ctx.strokeStyle = isDarkMode ? '#1a1a1a' : '#fff';
            ctx.stroke();
            
            ctx.fillStyle = isDarkMode ? '#1a1a1a' : '#fff';
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2 - 6, 72);
            ctx.lineTo(canvas.width / 2 - 1, 67);
            ctx.lineTo(canvas.width / 2 - 1, 77);
            ctx.fill();
        }
        
        // Á¢∞ÊíûÊ£ÄÊµã
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }
        
        // Âà§Êñ≠ÊòØÂê¶ÁîüÊàêÁâπÊÆäÊïå‰∫∫
        function shouldSpawnSpecialEnemy(enemyType) {
            switch (enemyType) {
                case 'birdBomb':
                    if (fireballLevel >= 15 && score >= 3000) {
                        if (specialEnemyCooldowns.birdBomb > 0) {
                            return false;
                        }
                        
                        let spawnChance = 0.1;
                        if (score >= 10000) spawnChance = 0.2;
                        if (score >= 30000) spawnChance = 0.3;
                        
                        if (birdBombs.length >= MAX_SPECIAL_ENEMIES.birdBombs) return false;
                        
                        return Math.random() < spawnChance;
                    }
                    return false;
                    
                default:
                    return false;
            }
        }
        
        // ÁîüÊàêÈöúÁ¢çÁâ©
        function spawnObstacle() {
            if (obstacles.length === 0) {
                const shouldSpawnBirdBomb = shouldSpawnSpecialEnemy('birdBomb');
                
                if (shouldSpawnBirdBomb) {
                    birdBombs.push(new BirdBomb(canvas.width, canvas.height - 30 - 30 - 15));
                    specialEnemyCooldowns.birdBomb = 180;
                } else {
                    const types = ['cactus', 'bird'];
                    const type = types[Math.floor(Math.random() * types.length)];
                    obstacles.push(new Obstacle(type));
                }
            } else {
                const lastObstacle = obstacles[obstacles.length - 1];
                const minGap = 200 + Math.random() * 200;
                
                if (lastObstacle.x < canvas.width - minGap) {
                    const shouldSpawnBirdBomb = shouldSpawnSpecialEnemy('birdBomb');
                    
                    if (shouldSpawnBirdBomb) {
                        birdBombs.push(new BirdBomb(canvas.width, canvas.height - 30 - 30 - 15));
                        specialEnemyCooldowns.birdBomb = 180;
                    } else {
                        const types = ['cactus', 'bird'];
                        const type = types[Math.floor(Math.random() * types.length)];
                        obstacles.push(new Obstacle(type));
                    }
                }
            }
        }
        
        // ÁîüÊàêÈÅìÂÖ∑ - ÈôêÂà∂ÊúÄÂ§ö5‰∏™
        function spawnPowerUp() {
            if (powerUps.length >= 5) return;
            
            if (Math.random() < 0.006 && gameRunning && !gameOver) {
                powerUps.push(new PowerUp());
            }
        }
        
        // ÁîüÊàê‰∫ëÊúµ
        function spawnCloud() {
            if (clouds.length === 0 || clouds[clouds.length - 1].x < canvas.width - 100 - Math.random() * 300) {
                clouds.push(new Cloud());
            }
        }
        
        // ÁîüÊàêÂ§ßÂç°ËΩ¶ - Èôç‰ΩéÊ¶ÇÁéá‰∏∫5%
        function spawnTruck() {
            if (specialEnemyCooldowns.truck > 0) {
                return;
            }
            
            if (fireballLevel < 30) {
                return;
            }
            
            let spawnChance = 0.0005;
            
            if (Math.random() < spawnChance && gameRunning && !gameOver && trucks.length < MAX_SPECIAL_ENEMIES.trucks) {
                trucks.push(new Truck());
                specialEnemyCooldowns.truck = 300;
            }
        }
        
        // ÁîüÊàêÁÇ∏ÂºπÈ£ûÊú∫
        function spawnBombPlane() {
            if (specialEnemyCooldowns.bombPlane > 0) {
                return;
            }
            
            if (fireballLevel < 20) {
                return;
            }
            
            let spawnChance = 0.001;
            
            if (score >= 10000 && score < 20000) {
                spawnChance = 0.0015;
            } else if (score >= 20000 && score < 50000) {
                spawnChance = 0.002;
            } else if (score >= 50000) {
                spawnChance = 0.003;
            }
            
            if (Math.random() < spawnChance && gameRunning && !gameOver && bombPlanes.length < MAX_SPECIAL_ENEMIES.bombPlanes) {
                bombPlanes.push(new BombPlane());
                specialEnemyCooldowns.bombPlane = 300;
            }
        }
        
        // Â§ßÂç°ËΩ¶Á±ª
        class Truck {
            constructor() {
                this.x = canvas.width;
                this.y = canvas.height - 30 - 100;
                this.width = 250;
                this.height = 100;
                this.speed = gameSpeed * 1.2;
                this.health = Math.max(score * 4, 100);
                this.maxHealth = this.health;
                this.color = '#ff0000';
                this.isImmuneToFire = false;
                this.isImmuneToLightning = true;
                this.isSuperLaserKill = false;
            }
            
            update() {
                this.x -= this.speed * 1.4;
            }
            
            draw() {
                ctx.fillStyle = this.color;
                
                const truckX = this.x;
                const truckY = this.y;
                
                ctx.fillRect(truckX, truckY + 40, 60, 40);
                ctx.fillRect(truckX + 20, truckY + 30, 40, 50);
                ctx.fillRect(truckX + 40, truckY + 10, 20, 20);
                
                this.drawPixelWheel(truckX + 10, truckY + 95, 10);
                this.drawPixelWheel(truckX + 40, truckY + 95, 10);
                
                ctx.fillRect(truckX + 60, truckY + 30, 160, 50);
                ctx.fillRect(truckX + 60, truckY + 80, 160, 20);
                
                ctx.fillStyle = isDarkMode ? '#1a1a1a' : '#CCCCCC';
                for (let i = 0; i < 3; i++) {
                    ctx.fillRect(truckX + 70 + i * 40, truckY + 35, 20, 15);
                }
                
                this.drawPixelWheel(truckX + 100, truckY + 95, 10);
                this.drawPixelWheel(truckX + 160, truckY + 95, 10);
                this.drawPixelWheel(truckX + 210, truckY + 95, 10);
                
                ctx.fillStyle = '#FFFF00';
                ctx.fillRect(truckX, truckY + 55, 5, 5);
                ctx.fillRect(truckX, truckY + 60, 5, 5);
                
                ctx.fillStyle = '#AAAAAA';
                ctx.fillRect(truckX + 10, truckY + 45, 5, 30);
                
                const barWidth = this.width;
                const barHeight = 6;
                const barY = this.y - 15;
                
                ctx.fillStyle = '#4b5563';
                ctx.fillRect(this.x, barY, barWidth, barHeight);
                
                ctx.fillStyle = '#ef4444';
                const healthPercent = this.health / this.maxHealth;
                ctx.fillRect(this.x, barY, barWidth * healthPercent, barHeight);
                
                ctx.fillStyle = '#ff0000';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ÊøÄÂÖâÊäóÊÄß x2', this.x + this.width/2, barY - 5);
            }
            
            drawPixelWheel(x, y, size) {
                ctx.fillStyle = '#333333';
                
                const radius = size / 2;
                
                ctx.fillRect(x - radius + 2, y - radius + 2, size - 4, size - 4);
                
                ctx.fillStyle = '#666666';
                ctx.fillRect(x - radius/2, y - radius/2, radius, radius);
                
                ctx.fillStyle = '#222222';
                ctx.fillRect(x - radius + 2, y - radius + 2, size - 4, 2);
                ctx.fillRect(x - radius + 2, y + radius - 4, size - 4, 2);
                ctx.fillRect(x - radius + 2, y - radius + 2, 2, size - 4);
                ctx.fillRect(x + radius - 4, y - radius + 2, 2, size - 4);
            }
            
            takeDamage(damage, isSuperLaser = false, isLaser = false) {
                if (isLaser) {
                    damage = Math.floor(damage / 2);
                }
                
                this.isSuperLaserKill = isSuperLaser;
                
                this.health -= damage;
                
                if (this.health <= 0) {
                    triggerGlobalExplosion(this.x + this.width/2, this.y + this.height/2, 15);
                    
                    if (!this.isSuperLaserKill) {
                        if (barrierCount > 0) {
                            barrierCount = 0;
                        } else if (!gmMode && invincibleTime <= 0) {
                            let truckDamage = Math.floor(lives / 3);
                            lives -= truckDamage;
                            triggerScreenShake(truckDamage, true);
                            if (lives <= 0) {
                                gameOver = true;
                                if (score > highScore) {
                                    highScore = score;
                                    localStorage.setItem('dinoHighScore', highScore);
                                }
                            }
                        }
                    }
                    
                    for (let i = enemies.length - 1; i >= 0; i--) {
                        const enemy = enemies[i];
                        enemy.takeDamage(10);
                        if (enemy.health <= 0) {
                            createExplosion(enemy.x, enemy.y, enemy.width, enemy.height);
                            enemies.splice(i, 1);
                            score += enemy.level * 10 * passiveScoreMultiplier * getScoreMultiplier();
                        }
                    }
                    
                    return true;
                }
                return false;
            }
            
            getHitbox() {
                return {
                    x: this.x + 10,
                    y: this.y,
                    width: this.width - 20,
                    height: this.height
                };
            }
            
            isOffScreen() {
                return this.x + this.width < -50;
            }
        }
        
        // Êõ¥Êñ∞ÊøÄÂÖâÁ≥ªÁªü
        function updateLaser() {
            if (fireballLevel >= 10 && fireballLevel < 20) {
                if (!laserActive && laserCooldown <= 0) {
                    document.getElementById('laserCooldown').style.display = 'block';
                }
                
                if (laserCooldown > 0) {
                    laserCooldown -= 1/60;
                    if (laserCooldown <= 0) {
                        laserCooldown = 0;
                        laserCharge = 0;
                    }
                }
                
                if (laserCooldown <= 0 && !isFiringLaser) {
                    laserCharge = Math.min(100, laserCharge + (1/60) * 20);
                }
                
                const cooldownBar = document.getElementById('laserCooldownBar');
                const cooldownText = document.getElementById('laserCooldownText');
                
                if (laserCooldown > 0) {
                    const percent = (15 - laserCooldown) / 15 * 100;
                    cooldownBar.style.width = percent + '%';
                    cooldownText.textContent = Math.ceil(laserCooldown) + 's';
                } else if (isFiringLaser) {
                    const percent = (5 - laserDuration) / 5 * 100;
                    cooldownBar.style.width = percent + '%';
                    cooldownText.textContent = Math.ceil(laserDuration) + 's';
                } else {
                    cooldownBar.style.width = laserCharge + '%';
                    cooldownText.textContent = Math.ceil(laserCharge) + '%';
                }
                
                if (laserActive) {
                    laserDuration -= 1/60;
                    if (laserDuration <= 0) {
                        laserActive = false;
                        laserCooldown = 15;
                        isFiringLaser = false;
                    }
                }
                
                if (isFiringLaser && laserActive && frameCount % 5 === 0) {
                    const fireballY = dino.y + dino.height / 2 - 6;
                    fireballs.push(new Fireball(dino.x + dino.width, fireballY));
                }
            } 
            else if (fireballLevel >= 20 && fireballLevel < 30) {
                if (!laserActive && laserCooldown <= 0) {
                    document.getElementById('laserCooldown').style.display = 'block';
                }
                
                if (laserCooldown > 0) {
                    laserCooldown -= 1/60;
                    if (laserCooldown <= 0) {
                        laserCooldown = 0;
                        laserCharge = 0;
                    }
                }
                
                if (laserCooldown <= 0 && !isFiringLaser) {
                    laserCharge = Math.min(100, laserCharge + (1/60) * 20);
                }
                
                const cooldownBar = document.getElementById('laserCooldownBar');
                const cooldownText = document.getElementById('laserCooldownText');
                
                if (laserCooldown > 0) {
                    const percent = (15 - laserCooldown) / 15 * 100;
                    cooldownBar.style.width = percent + '%';
                    cooldownText.textContent = Math.ceil(laserCooldown) + 's';
                } else if (isFiringLaser) {
                    const percent = (5 - laserDuration) / 5 * 100;
                    cooldownBar.style.width = percent + '%';
                    cooldownText.textContent = Math.ceil(laserDuration) + 's';
                } else {
                    cooldownBar.style.width = laserCharge + '%';
                    cooldownText.textContent = Math.ceil(laserCharge) + '%';
                }
                
                if (laserActive) {
                    laserDuration -= 1/60;
                    if (laserDuration <= 0) {
                        laserActive = false;
                        laserCooldown = 15;
                        isFiringLaser = false;
                    }
                }
                
                if (isFiringLaser && laserActive && frameCount % 3 === 0) {
                    const fireballY = dino.y + dino.height / 2 - 4;
                    fireballs.push(new Fireball(dino.x + dino.width, fireballY, false, 0, false, true));
                } else if (laserCooldown > 0 && isFiringLaser) {
                    if (frameCount % 5 === 0) {
                        const fireballY = dino.y + dino.height / 2 - 6;
                        fireballs.push(new Fireball(dino.x + dino.width, fireballY));
                    }
                }
            }
            else if (fireballLevel >= 30) {
                document.getElementById('laserCooldown').style.display = 'none';
                
                if (isFiringMiniLaser && frameCount % 3 === 0) {
                    const fireballY = dino.y + dino.height / 2 - 4;
                    fireballs.push(new Fireball(dino.x + dino.width, fireballY, false, 0, false, true));
                }
            } else {
                document.getElementById('laserCooldown').style.display = 'none';
            }
            
            updateSuperLaser();
        }
        
        // Êõ¥Êñ∞Èó™ÁîµÊäÄËÉΩ
        function updateLightningSkill() {
            if (lightningSkillActive) {
                lightningSkillDuration--;
                
                if (frameCount % 2 === 0) {
                    for (const rain of rainParticles) {
                        rain.update();
                    }
                }
                
                for (let i = lightningBolts.length - 1; i >= 0; i--) {
                    lightningBolts[i].update();
                    if (lightningBolts[i].isDead()) {
                        lightningBolts.splice(i, 1);
                    }
                }
                
                if (lightningSkillDuration <= 0) {
                    endLightningSkill();
                }
            }
            
            if (lightningSkillCooldown > 0) {
                lightningSkillCooldown--;
                
                const cooldownPercent = (15 * 60 - lightningSkillCooldown) / (15 * 60) * 100;
                document.getElementById('lightningCooldownBar').style.width = cooldownPercent + '%';
                document.getElementById('lightningCooldownText').textContent = Math.ceil(lightningSkillCooldown/60) + 's';
            }
            
            if (fireballLevel >= 40) {
                document.getElementById('lightningBtn').style.display = 'flex';
                document.getElementById('lightningCooldown').style.display = 'block';
            } else {
                document.getElementById('lightningBtn').style.display = 'none';
                document.getElementById('lightningCooldown').style.display = 'none';
            }
        }
        
        // Ëß¶ÂèëÂ±èÂπïÊäñÂä®
        function triggerScreenShake(damage, isTruck = false) {
            lastDamageTaken = damage;
            
            let shakeIntensity = Math.min(20, Math.max(5, Math.floor(damage / 2)));
            screenShake = 5 + shakeIntensity * 2;
            
            let borderThickness = Math.min(20, 5 + Math.floor(damage));
            let borderAlpha = Math.min(0.9, 0.3 + damage / 30);
            let borderRed = Math.min(255, 150 + damage * 5);
            
            let hitBorder = document.getElementById('hitBorder');
            hitBorder.style.borderWidth = borderThickness + 'px';
            hitBorder.style.borderColor = `rgba(${borderRed}, 0, 0, ${borderAlpha})`;
            hitBorder.style.display = 'block';
            
            if (damage > 25 || isTruck) {
                let redOverlay = document.createElement('div');
                redOverlay.className = 'screen-red-overlay';
                redOverlay.id = 'redOverlay';
                
                if (isTruck) {
                    redOverlay.style.backgroundColor = 'rgba(255, 0, 0, 0.5)';
                }
                
                document.body.appendChild(redOverlay);
                
                setTimeout(() => {
                    let opacity = isTruck ? 0.5 : 0.5;
                    let fadeInterval = setInterval(() => {
                        opacity -= 0.5;
                        if (opacity <= 0) {
                            clearInterval(fadeInterval);
                            let overlay = document.getElementById('redOverlay');
                            if (overlay) {
                                overlay.remove();
                            }
                        } else {
                            let overlay = document.getElementById('redOverlay');
                            if (overlay) {
                                overlay.style.backgroundColor = `rgba(255, 0, 0, ${opacity})`;
                            }
                        }
                    }, 5);
                }, 50);
                
                screenShake = isTruck ? 10 : 15;
            }
            
            document.getElementById('gameContainer').classList.add('screen-shake');
            
            setTimeout(() => {
                document.getElementById('gameContainer').classList.remove('screen-shake');
            }, 50);
        }
        
        // Êõ¥Êñ∞Êïå‰∫∫Á≥ªÁªü
        function updateEnemySystem() {
            if (score >= 500) {
                const spawnChance = Math.min(0.005 + (score / 50000), 0.01);
                
                if (Math.random() < spawnChance && gameRunning && !gameOver) {
                    if (enemies.length < 20) {
                        const enemyCount = Math.min(3, 20 - enemies.length);
                        for (let j = 0; j < enemyCount; j++) {
                            const enemy = new Enemy();
                            
                            let positionValid = true;
                            for (let existingEnemy of enemies) {
                                if (Math.abs(enemy.x - existingEnemy.x) < 100) {
                                    positionValid = false;
                                    break;
                                }
                            }
                            
                            if (positionValid) {
                                enemies.push(enemy);
                            }
                        }
                    }
                }
            }
            
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                if (enemy.update()) {
                    enemies.splice(i, 1);
                }
            }
        }
        
        // Êïå‰∫∫Á±ª
        class Enemy {
            constructor() {
                this.x = canvas.width - 200 + Math.random() * 150;
                this.y = 0;
                this.width = 44;
                this.height = 47;
                this.dy = 0;
                this.grounded = false;
                
                let baseLevel = Math.max(1, Math.min(Math.floor(score / 500), 10));
                if (hardMode) {
                    baseLevel = Math.max(1, Math.min(Math.floor(score / 300), 15));
                }
                
                this.level = baseLevel * hardModeMultiplier;
                this.health = this.level * 2;
                this.maxHealth = this.level * 2;
                
                this.shootCooldown = 0;
                this.shootInterval = 120 - Math.min(this.level * 5, 80);
                this.jumpCooldown = 0;
                
                this.runFrame = 0;
                this.facingLeft = true;
                
                this.powerUpTime = enemyPowerUps.powerUpTime;
                this.infinitePenetrationTime = enemyPowerUps.infinitePenetrationTime;
                this.damageMultiplier = enemyPowerUps.damageMultiplier;
                
                this.paralyzed = 0;
                
                this.canUseLaser = fireballLevel >= 20;
                this.isUsingLaser = false;
                this.laserCharge = 100;
            }
            
            update() {
                if (this.paralyzed > 0) {
                    this.paralyzed--;
                    return;
                }
                
                this.powerUpTime = enemyPowerUps.powerUpTime;
                this.infinitePenetrationTime = enemyPowerUps.infinitePenetrationTime;
                this.damageMultiplier = enemyPowerUps.damageMultiplier;
                
                this.dy += GRAVITY;
                this.y += this.dy;
                
                const groundY = canvas.height - 30 - this.height;
                if (this.y >= groundY) {
                    this.y = groundY;
                    this.dy = 0;
                    this.grounded = true;
                }
                
                if (this.grounded && frameCount % 5 === 0) {
                    this.runFrame = (this.runFrame + 1) % 2;
                }
                
                this.shootCooldown--;
                if (this.shootCooldown <= 0 && this.grounded) {
                    this.shoot();
                    this.shootCooldown = this.shootInterval;
                }
                
                this.jumpCooldown--;
                if (this.jumpCooldown <= 0 && this.grounded) {
                    for (let fireball of fireballs) {
                        if (fireball.x > this.x - 100 && fireball.x < this.x + 50) {
                            this.jump();
                            this.jumpCooldown = 60;
                            break;
                        }
                    }
                }
                
                if (this.x + this.width < 0) {
                    return true;
                }
                
                return false;
            }
            
            jump() {
                if (this.grounded) {
                    this.dy = -12;
                    this.grounded = false;
                }
            }
            
            shoot() {
                const fireballY = this.y + this.height / 2 - 6;
                
                if (this.canUseLaser && Math.random() > 0.5) {
                    this.isUsingLaser = true;
                    enemyFireballs.push(new Fireball(this.x - 20, fireballY, true, this.level, false, true));
                    
                    if (frameCount % 10 === 0) {
                        enemyFireballs.push(new Fireball(this.x - 20, fireballY, true, this.level, false, true));
                    }
                } else {
                    this.isUsingLaser = false;
                    enemyFireballs.push(new Fireball(this.x - 20, fireballY, true, this.level, false, false));
                }
            }
            
            draw() {
                ctx.save();
                
                ctx.fillStyle = '#dc2626';
                
                const barWidth = this.width;
                const barHeight = 4;
                const barY = this.y - 10;
                
                ctx.fillStyle = '#4b5563';
                ctx.fillRect(this.x, barY, barWidth, barHeight);
                
                ctx.fillStyle = '#ef4444';
                const healthPercent = this.health / this.maxHealth;
                ctx.fillRect(this.x, barY, barWidth * healthPercent, barHeight);
                
                if (this.paralyzed > 0) {
                    ctx.strokeStyle = 'rgba(0, 204, 255, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    for (let i = 0; i < 5; i++) {
                        const angle = (frameCount * 0.1 + i * Math.PI * 0.4) % (Math.PI * 2);
                        const radius = this.width / 2 + 10;
                        const x1 = this.x + this.width/2 + Math.cos(angle) * radius;
                        const y1 = this.y + this.height/2 + Math.sin(angle) * radius;
                        const x2 = this.x + this.width/2 + Math.cos(angle + Math.PI/8) * (radius - 5);
                        const y2 = this.y + this.height/2 + Math.sin(angle + Math.PI/8) * (radius - 5);
                        
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                    }
                    ctx.stroke();
                }
                
                ctx.scale(-1, 1);
                ctx.translate(-this.x * 2 - this.width, 0);
                
                if (this.powerUpTime > 0) {
                    ctx.save();
                    ctx.strokeStyle = '#4dabf7';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/2, this.y + this.height/2, this.width/2 + 5, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.restore();
                }
                
                if (this.isUsingLaser && frameCount % 10 < 5) {
                    ctx.save();
                    ctx.fillStyle = 'rgba(0, 255, 0, 0.3)';
                    ctx.fillRect(this.x - 10, this.y + this.height/2 - 4, 30, 8);
                    ctx.restore();
                }
                
                this.drawDino();
                
                ctx.restore();
            }
            
            drawDino() {
                const headY = this.y;
                const bodyY = this.y + 20;
                
                ctx.fillRect(this.x + 18, headY, 16, 12);
                ctx.fillRect(this.x + 34, headY + 6, 4, 6);
                ctx.fillRect(this.x + 16, headY + 12, 18, 10);
                
                ctx.fillRect(this.x + 30, headY + 6, 2, 3);
                
                ctx.fillRect(this.x + 16, bodyY + 2, 22, 16);
                
                ctx.fillRect(this.x + 6, bodyY + 4, 10, 4);
                ctx.fillRect(this.x + 4, bodyY, 2, 4);
                
                ctx.fillRect(this.x + 30, bodyY + 10, 6, 2);
                
                if (this.grounded) {
                    if (this.runFrame === 0) {
                        ctx.fillRect(this.x + 18, bodyY + 18, 4, 8);
                        ctx.fillRect(this.x + 18, bodyY + 26, 6, 2);
                        ctx.fillRect(this.x + 28, bodyY + 18, 4, 6);
                    } else {
                        ctx.fillRect(this.x + 18, bodyY + 18, 4, 6);
                        ctx.fillRect(this.x + 28, bodyY + 18, 4, 8);
                        ctx.fillRect(this.x + 28, bodyY + 26, 6, 2);
                    }
                } else {
                    ctx.fillRect(this.x + 18, bodyY + 18, 4, 6);
                    ctx.fillRect(this.x + 28, bodyY + 18, 4, 6);
                }
            }
            
            getHitbox() {
                return {
                    x: this.x + 16,
                    y: this.y,
                    width: 22,
                    height: 47
                };
            }
            
            takeDamage(damage) {
                let actualDamage = damage;
                if (this.powerUpTime > 0) {
                    actualDamage = Math.max(1, Math.floor(damage / 2));
                }
                
                this.health -= actualDamage;
                return this.health <= 0;
            }
            
            paralyze() {
                this.paralyzed = 60;
            }
        }
        
        // ===============================
        // ‰∏ªÊõ¥Êñ∞ÂáΩÊï∞
        // ===============================
        function update() {
            if (!gameRunning || gameOver || gamePaused) {
                return;
            }
            
            frameCount++;
            
            // Ë∞ÉÊï¥ÂàÜÊï∞Ëé∑ÂèñÈÄüÂ∫¶ÔºàÂ∫îÁî®Ê®°ÂºèÁâπÂÆöÁöÑÂàÜÊï∞ÂÄçÊï∞Ôºâ
            let scoreIncrement = 0.1;
            if (score < 1000) {
                scoreIncrement = 0.05;
            } else if (score < 5000) {
                scoreIncrement = 0.08;
            } else if (score < 10000) {
                scoreIncrement = 0.12;
            } else {
                scoreIncrement = 0.2;
            }
            
            score += scoreIncrement * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
            
            gameTime += 1/60;
            
            if (!endlessMode && gameTime >= MAX_GAME_TIME) {
                gameOver = true;
                document.getElementById('gameOverScreen').style.display = 'flex';
                document.getElementById('gameOverMessage').textContent = 'Êó∂Èó¥Â∑≤Âà∞20ÂàÜÈíüÔºÅ';
                return;
            }
            
            // Âú®ÊøÄÊ¥ªÂõ∞ÈöæÊ®°ÂºèÊó∂
            if (score >= HARD_MODE_THRESHOLD && !hardMode) {
                hardMode = true;
                hardModeStartScore = score;
                hardModeMultiplier = 3; // Âü∫Á°ÄÂÄçÊï∞3
                document.getElementById('difficultyIndicator').style.display = 'block';
                document.getElementById('difficultyIndicator').textContent = 'Âõ∞ÈöæÊ®°Âºè x3';
                createFloatingText("‚ö†Ô∏è Âõ∞ÈöæÊ®°ÂºèÊøÄÊ¥ªÔºÅ", canvas.width/2, 100, '#ff0000', 180);
            }
            
            // Âú®ÊøÄÊ¥ªÂô©Ê¢¶Ê®°ÂºèÊó∂
            if (score >= NIGHTMARE_MODE_THRESHOLD && !nightmareMode) {
                nightmareMode = true;
                nightmareModeStartScore = score;
                // ÁªßÊâøÂõ∞ÈöæÊ®°ÂºèÁöÑÊúÄÁªàÂÄçÊï∞ÔºåÁÑ∂Âêé‰πò‰ª•16
                hardModeMultiplier = hardModeMultiplier * 16;
                document.getElementById('difficultyIndicator').style.display = 'block';
                document.getElementById('difficultyIndicator').textContent = 'Âô©Ê¢¶Ê®°Âºè x' + hardModeMultiplier.toFixed(1);
                createFloatingText("‚ö†Ô∏è Âô©Ê¢¶Ê®°ÂºèÊøÄÊ¥ªÔºÅ", canvas.width/2, 100, '#8b0000', 180);
            }
            
            // Âú®ÊøÄÊ¥ªÂú∞Áã±Ê®°ÂºèÊó∂
            if (score >= HELL_MODE_THRESHOLD && !hellMode) {
                hellMode = true;
                hellModeStartScore = score;
                // ÁªßÊâøÂô©Ê¢¶Ê®°ÂºèÁöÑÊúÄÁªàÂÄçÊï∞ÔºåÁÑ∂Âêé‰πò‰ª•32
                hardModeMultiplier = hardModeMultiplier * 32;
                document.getElementById('difficultyIndicator').style.display = 'block';
                document.getElementById('difficultyIndicator').textContent = 'Âú∞Áã±Ê®°Âºè x' + hardModeMultiplier.toFixed(1);
                createFloatingText("‚ö†Ô∏è Âú∞Áã±Ê®°ÂºèÊøÄÊ¥ªÔºÅ", canvas.width/2, 100, '#000000', 180);
            }
            
            // Êõ¥Êñ∞Âõ∞ÈöæÊ®°ÂºèÂÄçÊï∞ÔºàÊåáÊï∞Á∫ßÂ¢ûÈïøÔºâ
            updateHardModeMultiplier();
            
            // ÂÆöÊúüÊòæÁ§∫ÈöæÂ∫¶ÂÄçÊï∞ÔºàÊØè10ÁßíÊèêÁ§∫‰∏ÄÊ¨°Ôºâ- Âè™Âú®ÂØπÂ∫îÊ®°ÂºèÊøÄÊ¥ªÊó∂ÊòæÁ§∫
            if (frameCount % 600 === 0 && hardMode) {
                let modeName, color;
                if (hellMode) {
                    modeName = "Âú∞Áã±";
                    color = '#000000';
                } else if (nightmareMode) {
                    modeName = "Âô©Ê¢¶";
                    color = '#8b0000';
                } else if (hardMode) {
                    modeName = "Âõ∞Èöæ";
                    color = '#ff0000';
                }
                
                if (modeName) {
                    createFloatingText(
                        `‚ö†Ô∏è ${modeName}Ê®°ÂºèÈöæÂ∫¶ÊèêÂçáËá≥ x${hardModeMultiplier.toFixed(1)}`,
                        canvas.width/2, 150, 
                        color, 
                        180
                    );
                }
            }
            
            // Êõ¥Êñ∞Â§©Ê∞îÁ≥ªÁªü
            weatherTimer++;
            if (weatherTimer >= WEATHER_CHANGE_INTERVAL) {
                weatherTimer = 0;
                const weathers = ['sunny', 'rainy', 'snowy'];
                currentWeather = weathers[Math.floor(Math.random() * weathers.length)];
                
                if (currentWeather === 'rainy' && !lightningSkillActive) {
                    rainParticles = [];
                    for (let i = 0; i < 20; i++) {
                        rainParticles.push(new RainParticle());
                    }
                } else if (currentWeather === 'snowy') {
                    snowParticles = [];
                    for (let i = 0; i < 30; i++) {
                        snowParticles.push(new SnowParticle());
                    }
                } else if (currentWeather === 'sunny') {
                    rainParticles = [];
                    snowParticles = [];
                }
            }
            
            if (currentWeather === 'rainy' && !lightningSkillActive) {
                for (const rain of rainParticles) {
                    if (frameCount % 2 === 0) rain.update();
                }
            } else if (currentWeather === 'snowy') {
                for (const snow of snowParticles) {
                    if (frameCount % 2 === 0) snow.update();
                }
            }
            
            // Êõ¥Êñ∞Ë¢´Âä®ÊäÄËÉΩ
            if (fireballLevel >= 80) {
                passiveScoreMultiplier = 2;
            }
            
            if (fireballLevel >= 90) {
                passiveBuffMultiplier = 2;
            }
            
            if (fireballLevel >= 100) {
                immuneObstacle = true;
            }
            
            if (fireballLevel >= 130) {
                immuneFireball = true;
            }
            
            if (fireballLevel >= 140) {
                immuneBomb = true;
            }
            
            // ÁîüÂëΩÁ≥ªÁªüÊîπËøõÔºöÊØè70ÂàÜÂõûÂ§ç‰∏ÄÊù°ÂëΩ
            if (score - lastLifeBonus >= 70) {
                lives = Math.min(lives + 1, maxLives);
                lastLifeBonus = Math.floor(score / 70) * 70;
            }
            
            // ÊØè150ÂàÜÂ¢ûÂä†20ÁÇπÊúÄÂ§ßÁîüÂëΩÂÄº
            if (score - lastLifeUpBonus >= 150) {
                maxLives += 20;
                lastLifeUpBonus = Math.floor(score / 150) * 150;
            }
            
            // ÊåÅÁª≠Ê≤ªÁñóÊïàÊûú
            if (healOverTime > 0) {
                healOverTime--;
                healOverTimeTimer++;
                if (healOverTimeTimer >= 20) {
                    healOverTimeTimer = 0;
                    lives = Math.min(lives + 30, maxLives);
                }
            }
            
            // Ë¢´Âä®Â±èÈöúËé∑ÂèñÁ≥ªÁªü
            let barrierScoreThreshold = 700;
            if (fireballLevel >= 110) {
                barrierScoreThreshold = 500;
            }
            if (fireballLevel >= 120) {
                barrierScoreThreshold = 400;
            }
            
            if (fireballLevel >= 70) {
                passiveBarrierTimer++;
                if (passiveBarrierTimer >= 60) {
                    passiveBarrierTimer = 0;
                    if (score - lastPassiveBarrierScore >= barrierScoreThreshold) {
                        barrierCount++;
                        lastPassiveBarrierScore = Math.floor(score / barrierScoreThreshold) * barrierScoreThreshold;
                        createFloatingText("üõ°Ô∏è Ë¢´Âä®Â±èÈöú+1", dino.x, dino.y - 50, '#ffffff', 60);
                    }
                }
            }
            
            // 160Á∫ßË¢´Âä®ÔºöÊØè200ÂàÜÊÅ¢Â§ç300ÁîüÂëΩÂÄº
            if (fireballLevel >= 160) {
                if (score - lastLifeRecoveryBonus >= 200) {
                    lives = Math.min(lives + 300, maxLives);
                    lastLifeRecoveryBonus = Math.floor(score / 200) * 200;
                    createFloatingText("‚ù§Ô∏è ÊÅ¢Â§ç300ÁîüÂëΩ", dino.x, dino.y - 50, '#ff6b6b', 60);
                }
            }
            
            if (!lightningSkillActive) {
                themeTimer++;
                if (themeTimer >= 3600) {
                    themeTimer = 0;
                    targetDarkMode = !targetDarkMode;
                }
                
                if (targetDarkMode && themeTransition < 1) {
                    themeTransition += 0.005;
                } else if (!targetDarkMode && themeTransition > 0) {
                    themeTransition -= 0.005;
                }
                themeTransition = Math.max(0, Math.min(1, themeTransition));
                isDarkMode = themeTransition > 0.5;
            }
            
            if (screenShake > 0) screenShake--;
            if (screenShake <= 0) {
                document.getElementById('gameContainer').classList.remove('screen-shake');
            }
            
            if (hitEffect > 0) {
                hitEffect--;
                const alpha = hitEffect / 30 * 0.3 * (1 + lastDamageTaken / 50);
                const thickness = 5 + Math.min(10, lastDamageTaken / 3);
                document.getElementById('hitBorder').style.borderWidth = thickness + 'px';
                document.getElementById('hitBorder').style.borderColor = `rgba(255, 0, 0, ${alpha})`;
            } else {
                document.getElementById('hitBorder').style.display = 'none';
            }
            
            // Êñ∞ÁöÑÂçáÁ∫ßÁ≥ªÁªüÔºöÊåâÁ≠âÁ∫ßÂå∫Èó¥Ë∞ÉÊï¥
            let upgradeThreshold;
            if (fireballLevel >= 100) {
                upgradeThreshold = 500;
            } else if (fireballLevel >= 75) {
                upgradeThreshold = 1000;
            } else if (fireballLevel >= 65) {
                upgradeThreshold = 2000;
            } else if (fireballLevel >= 50) {
                upgradeThreshold = 3000;
            } else if (fireballLevel >= 40) {
                upgradeThreshold = 4000;
            } else if (fireballLevel >= 35) {
                upgradeThreshold = 5000;
            } else if (fireballLevel >= 30) {
                upgradeThreshold = 5500;
            } else if (fireballLevel >= 25) {
                upgradeThreshold = 6000;
            } else {
                const BASE_THRESHOLD = 2000;
                upgradeThreshold = BASE_THRESHOLD * Math.pow(2, fireballLevel - 1);
            }
            
            if (score - lastFireballBonus >= upgradeThreshold) {
                if (fireballLevel < MAX_FIREBALL_LEVEL) {
                    fireballLevel++;
                    fireballDamage = fireballLevel;
                    
                    lives = maxLives;
                    
                    if (fireballLevel % 10 === 0) {
                        maxLives += fireballLevel * 10;
                        lives = maxLives;
                    }
                    
                    createFloatingText(`üî• Á≠âÁ∫ß ${fireballLevel}`, dino.x, dino.y - 30, '#ff6b6b', 90);
                    
                    if (fireballLevel === 80) {
                        createFloatingText("üéâ Ëß£ÈîÅË¢´Âä®ÔºöÂàÜÊï∞x2", dino.x, dino.y - 80, '#ffff00', 180);
                    } else if (fireballLevel === 90) {
                        createFloatingText("üéâ Ëß£ÈîÅË¢´Âä®ÔºöÂ¢ûÁõäÊïàÊûúx2", dino.x, dino.y - 80, '#ffff00', 180);
                    } else if (fireballLevel === 100) {
                        createFloatingText("üéâ Ëß£ÈîÅË¢´Âä®ÔºöÂÖçÁñ´ÈöúÁ¢çÁâ©", dino.x, dino.y - 80, '#ffff00', 180);
                    } else if (fireballLevel === 110) {
                        createFloatingText("üéâ Ëß£ÈîÅË¢´Âä®ÔºöÊØè500ÂàÜËé∑ÂæóÂ±èÈöú", dino.x, dino.y - 80, '#ffff00', 180);
                    } else if (fireballLevel === 120) {
                        createFloatingText("üéâ Ëß£ÈîÅË¢´Âä®ÔºöÊØè400ÂàÜËé∑ÂæóÂ±èÈöú", dino.x, dino.y - 80, '#ffff00', 180);
                    } else if (fireballLevel === 130) {
                        createFloatingText("üéâ Ëß£ÈîÅË¢´Âä®ÔºöÂÖçÁñ´ÁÅ´ÁêÉ‰º§ÂÆ≥", dino.x, dino.y - 80, '#ffff00', 180);
                    } else if (fireballLevel === 140) {
                        createFloatingText("üéâ Ëß£ÈîÅË¢´Âä®ÔºöÂÖçÁñ´ÁÇ∏Âºπ‰º§ÂÆ≥", dino.x, dino.y - 80, '#ffff00', 180);
                    } else if (fireballLevel === 150) {
                        createFloatingText("üéâ Ëß£ÈîÅË¢´Âä®ÔºöË∂ÖÁ∫ßÊøÄÂÖâÂº∫Âåñ", dino.x, dino.y - 80, '#ffff00', 180);
                        superLaserChargeTime = 30;
                        superLaserDamageMultiplier = 64;
                        superLaserDurationTime = 30;
                    } else if (fireballLevel === 160) {
                        createFloatingText("üéâ Ëß£ÈîÅË¢´Âä®ÔºöÊØè200ÂàÜÊÅ¢Â§ç300ÁîüÂëΩ", dino.x, dino.y - 80, '#ffff00', 180);
                    } else if (fireballLevel === 170) {
                        createFloatingText("üéâ Ëß£ÈîÅË¢´Âä®ÔºöÁîüÂëΩÊÅ¢Â§çÂº∫Âåñ", dino.x, dino.y - 80, '#ffff00', 180);
                        lives = maxLives;
                        healOverTime = 30 * 60;
                        healOverTimeTimer = 0;
                    } else if (fireballLevel === 180) {
                        createFloatingText("üéâ Ëß£ÈîÅË¢´Âä®ÔºöË∂ÖÁ∫ßÊøÄÂÖâÁªàÊûÅÂº∫Âåñ", dino.x, dino.y - 80, '#ffff00', 180);
                        superLaserChargeTime = 60;
                        superLaserDamageMultiplier = 0;
                        superLaserDurationTime = 45;
                        superLaserInstantKill = true;
                    }
                } else {
                    fireballDamage++;
                    createFloatingText(`üî• ‰º§ÂÆ≥ ${fireballDamage}`, dino.x, dino.y - 30, '#ff6b6b', 90);
                }
                lastFireballBonus = Math.floor(score / upgradeThreshold) * upgradeThreshold;
            }
            
            let speedLevel = Math.floor(fireballLevel / 5);
            let baseSpeed = 3;
            gameSpeed = Math.min(10, baseSpeed + speedLevel * 0.3);
            
            if (invincibleTime > 0) invincibleTime -= 1/60;
            if (powerUpTime > 0) powerUpTime -= 1/60;
            if (infinitePenetrationTime > 0) {
                infinitePenetrationTime -= 1/60;
                hasInfinitePenetration = true;
            } else {
                hasInfinitePenetration = false;
            }
            
            enemyPowerUps.powerUpTime = powerUpTime;
            enemyPowerUps.infinitePenetrationTime = infinitePenetrationTime;
            enemyPowerUps.damageMultiplier = scoreMultiplier;
            
            updateLaser();
            updateLightningSkill();
            
            if (invulnerableFlash > 0) {
                invulnerableFlash++;
                if (invulnerableFlash >= 180) {
                    invulnerableFlash = 0;
                }
            }
            
            for (let key in specialEnemyCooldowns) {
                if (specialEnemyCooldowns[key] > 0) {
                    specialEnemyCooldowns[key]--;
                }
            }
            
            dino.update();
            
            spawnCloud();
            clouds.forEach(cloud => cloud.update());
            clouds = clouds.filter(cloud => !cloud.isOffScreen());
            
            spawnObstacle();
            obstacles.forEach(obstacle => obstacle.update());
            obstacles = obstacles.filter(obstacle => !obstacle.isOffScreen());
            
            spawnPowerUp();
            powerUps.forEach(powerUp => powerUp.update());
            powerUps = powerUps.filter(powerUp => !powerUp.isOffScreen());
            
            spawnTruck();
            spawnBombPlane();
            
            updateEnemySystem();
            
            for (let i = birdBombs.length - 1; i >= 0; i--) {
                const bird = birdBombs[i];
                if (bird.update()) {
                    birdBombs.splice(i, 1);
                }
            }
            
            for (let i = bombPlanes.length - 1; i >= 0; i--) {
                const plane = bombPlanes[i];
                if (plane.update()) {
                    bombPlanes.splice(i, 1);
                }
            }
            
            for (let i = bombs.length - 1; i >= 0; i--) {
                const bomb = bombs[i];
                if (bomb.update()) {
                    bombs.splice(i, 1);
                }
            }
            
            for (let i = trucks.length - 1; i >= 0; i--) {
                const truck = trucks[i];
                truck.update();
                
                const truckHitbox = truck.getHitbox();
                const dinoHitbox = dino.getHitbox();
                
                if (checkCollision(truckHitbox, dinoHitbox)) {
                    if (barrierCount > 0) {
                        barrierCount = 0;
                    } else if (!gmMode && invincibleTime <= 0) {
                        lives -= 30 * hardModeMultiplier;
                        triggerScreenShake(30 * hardModeMultiplier, true);
                        if (lives <= 0) {
                            gameOver = true;
                            if (score > highScore) {
                                highScore = score;
                                localStorage.setItem('dinoHighScore', highScore);
                            }
                        }
                    }
                }
                
                if (truck.isOffScreen()) {
                    trucks.splice(i, 1);
                }
            }
            
            fireballs.forEach(fireball => fireball.update());
            fireballs = fireballs.filter(fireball => !fireball.isOffScreen());
            
            enemyFireballs.forEach(fireball => fireball.update());
            enemyFireballs = enemyFireballs.filter(fireball => !fireball.isOffScreen());
            
            for (let i = fireballs.length - 1; i >= 0; i--) {
                const fireball = fireballs[i];
                const fireballHitbox = fireball.getHitbox();
                
                for (let j = obstacles.length - 1; j >= 0; j--) {
                    const obstacle = obstacles[j];
                    const obstacleHitbox = obstacle.getHitbox();
                    
                    if (checkCollision(fireballHitbox, obstacleHitbox)) {
                        createExplosion(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                        obstacles.splice(j, 1);
                        score += 5 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                        fireball.hit++;
                        break;
                    }
                }
                
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    const enemyHitbox = enemy.getHitbox();
                    
                    if (checkCollision(fireballHitbox, enemyHitbox)) {
                        const damage = fireball.damage;
                        const isDead = enemy.takeDamage(damage);
                        
                        if (isDead) {
                            createExplosion(enemy.x, enemy.y, enemy.width, enemy.height);
                            enemies.splice(j, 1);
                            score += enemy.level * 10 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                            
                            if (lightningSkillActive && frameCount - lastLightningTime > 30 && Math.random() > 0.7) {
                                lightningBolts.push(new LightningBolt(enemy.x, enemy.y));
                                lastLightningTime = frameCount;
                            }
                        } else {
                            if (lightningSkillActive && frameCount - lastLightningTime > 30 && Math.random() > 0.8) {
                                enemy.paralyze();
                                lightningBolts.push(new LightningBolt(enemy.x, enemy.y));
                                lastLightningTime = frameCount;
                            }
                        }
                        
                        fireball.hit++;
                        break;
                    }
                }
                
                for (let j = trucks.length - 1; j >= 0; j--) {
                    const truck = trucks[j];
                    const truckHitbox = truck.getHitbox();
                    
                    if (checkCollision(fireballHitbox, truckHitbox)) {
                        const isDead = truck.takeDamage(fireball.damage, fireball.isSuperLaser, fireball.isLaser);
                        
                        if (isDead) {
                            trucks.splice(j, 1);
                            score += 100 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                        }
                        
                        fireball.hit++;
                        break;
                    }
                }
                
                for (let j = bombPlanes.length - 1; j >= 0; j--) {
                    const plane = bombPlanes[j];
                    if (!plane.isExploded) {
                        const planeHitbox = plane.getHitbox();
                        
                        if (checkCollision(fireballHitbox, planeHitbox)) {
                            if (fireball.isLaser || fireball.isSuperLaser) {
                                plane.explode();
                                bombPlanes.splice(j, 1);
                            } else {
                                plane.explode();
                                bombPlanes.splice(j, 1);
                            }
                            fireball.hit++;
                            break;
                        }
                    }
                }
                
                for (let j = birdBombs.length - 1; j >= 0; j--) {
                    const bird = birdBombs[j];
                    if (!bird.isExploded) {
                        const birdHitbox = bird.getHitbox();
                        
                        if (checkCollision(fireballHitbox, birdHitbox)) {
                            if (fireball.isLaser || fireball.isSuperLaser) {
                                bird.explode(true);
                                birdBombs.splice(j, 1);
                            } else {
                                birdBombs.splice(j, 1);
                                createExplosion(bird.x, bird.y, bird.width, bird.height);
                            }
                            fireball.hit++;
                            break;
                        }
                    }
                }
                
                for (let j = bombs.length - 1; j >= 0; j--) {
                    const bomb = bombs[j];
                    if (!bomb.isExploded) {
                        const bombHitbox = bomb.getHitbox();
                        
                        if (checkCollision(fireballHitbox, bombHitbox)) {
                            bomb.explode();
                            bombs.splice(j, 1);
                            fireball.hit++;
                            break;
                        }
                    }
                }
            }
            
            for (let i = enemyFireballs.length - 1; i >= 0; i--) {
                const fireball = enemyFireballs[i];
                const fireballHitbox = fireball.getHitbox();
                const dinoHitbox = dino.getHitbox();
                
                if (checkCollision(fireballHitbox, dinoHitbox)) {
                    if (barrierCount > 0) {
                        barrierCount--;
                        createExplosion(fireball.x, fireball.y, fireball.width, fireball.height);
                    } else if (!gmMode && invincibleTime <= 0 && !immuneFireball) {
                        let damage = fireball.damage;
                        
                        if (score >= 3000) {
                            damage = 10 + Math.floor((score - 3000) / 100);
                        }
                        
                        lives -= damage;
                        
                        const scorePenalty = 10;
                        score = Math.max(0, score - scorePenalty);
                        
                        triggerScreenShake(damage);
                        
                        invulnerableFlash = 1;
                        
                        if (lives <= 0) {
                            gameOver = true;
                            if (score > highScore) {
                               highScore = score;
                               localStorage.setItem('dinoHighScore', highScore);
                           }
                       }
                    }
                    enemyFireballs.splice(i, 1);
                }
            }
            
            const dinoHitbox = dino.getHitbox();
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                const powerUpHitbox = powerUp.getHitbox();
                
                if (checkCollision(dinoHitbox, powerUpHitbox)) {
                    if (powerUp.type === 'invincible') {
                        invincibleTime = 20 * passiveBuffMultiplier * getBuffMultiplier();
                    } else if (powerUp.type === 'powerup') {
                        powerUpTime = 20 * passiveBuffMultiplier * getBuffMultiplier();
                    } else if (powerUp.type === 'life') {
                        maxLives += 50;
                        lives = maxLives;
                        if (fireballLevel < MAX_FIREBALL_LEVEL) {
                            fireballLevel++;
                            fireballDamage = fireballLevel;
                        }
                    } else if (powerUp.type === 'barrier') {
                        barrierCount = 3;
                    } else if (powerUp.type === 'ultimate') {
                        // Â∫îÁî®Ê®°ÂºèÁâπÂÆöÁöÑÂ¢ûÁõäÂÄçÊï∞
                        let buffMult = getBuffMultiplier();
                        invincibleTime = 30 * passiveBuffMultiplier * buffMult;
                        powerUpTime = 30 * passiveBuffMultiplier * buffMult;
                        infinitePenetrationTime = 30 * passiveBuffMultiplier * buffMult;
                        barrierCount += 3;
                        healOverTime = 30 * 60 * passiveBuffMultiplier * buffMult;
                        healOverTimeTimer = 0;
                        maxLives += 100;
                        lives = maxLives;
                    } else if (powerUp.type === 'rainbow') {
                        maxLives += 50;
                        lives = maxLives;
                        invincibleTime = 3 * passiveBuffMultiplier * getBuffMultiplier();
                    } else if (powerUp.type === 'triColor') {
                        score += 500 * getScoreMultiplier();
                        createFloatingText("+500ÂàÜ", dino.x, dino.y - 50, '#00ff00', 120);
                    } else if (powerUp.type === 'score') {
                        score += 200 * getScoreMultiplier();
                        createFloatingText("+200ÂàÜ", dino.x, dino.y - 50, '#ffff00', 120);
                    }
                    
                    powerUps.splice(i, 1);
                    
                    const colors = {
                        'invincible': '#ff6b6b',
                        'powerup': '#4dabf7',
                        'life': '#51cf66',
                        'barrier': '#ffffff',
                        'ultimate': '#ffd700',
                        'rainbow': '#ffffff',
                        'triColor': '#00ff00',
                        'score': '#ffff00',
                    };
                    for (let k = 0; k < 10; k++) {
                        particles.push(new Particle(powerUp.x, powerUp.y, colors[powerUp.type]));
                    }
                }
            }
            
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obstacle = obstacles[i];
                const obstacleHitbox = obstacle.getHitbox();
                
                if (checkCollision(dinoHitbox, obstacleHitbox)) {
                    if (gmMode || invincibleTime > 0 || immuneObstacle) {
                        createExplosion(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                        obstacles.splice(i, 1);
                        score += 10 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                    } else {
                        if (barrierCount > 0) {
                            barrierCount--;
                            obstacles.splice(i, 1);
                            createExplosion(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                            score += 10 * scoreMultiplier * passiveScoreMultiplier * getScoreMultiplier();
                        } else {
                            const difficultyFactor = Math.floor(score / 1000) + 1;
                            const baseDamage = 1;
                            const damage = Math.min(3, baseDamage + Math.floor(difficultyFactor / 5));
                            
                            lives -= damage;
                            
                            const scorePenalty = 10;
                            score = Math.max(0, score - scorePenalty);
                            
                            triggerScreenShake(damage);
                            
                            invulnerableFlash = 1;
                            
                              if (lives <= 0) {
                                gameOver = true;
                                if (score > highScore) {
                                    highScore = score;
                                    localStorage.setItem('dinoHighScore', highScore);
                                }
                            }
                            
                            obstacles.splice(i, 1);
                        }
                    }
                }
            }
            
            for (let i = birdBombs.length - 1; i >= 0; i--) {
                const bird = birdBombs[i];
                if (!bird.isExploded) {
                    const birdHitbox = bird.getHitbox();
                    
                    if (checkCollision(dinoHitbox, birdHitbox)) {
                        bird.explode(false);
                        birdBombs.splice(i, 1);
                    }
                }
            }
            
            for (let i = bombPlanes.length - 1; i >= 0; i--) {
                const plane = bombPlanes[i];
                if (!plane.isExploded) {
                    const planeHitbox = plane.getHitbox();
                    
                    if (checkCollision(dinoHitbox, planeHitbox)) {
                        plane.explode();
                        bombPlanes.splice(i, 1);
                    }
                }
            }
            
            for (let i = bombs.length - 1; i >= 0; i--) {
                const bomb = bombs[i];
                if (!bomb.isExploded) {
                    const bombHitbox = bomb.getHitbox();
                    
                    if (checkCollision(dinoHitbox, bombHitbox)) {
                        bomb.explode();
                        bombs.splice(i, 1);
                    }
                }
            }
            
            particles.forEach(particle => {
                if (particle.type === 'text') {
                    particle.y += particle.vy;
                    particle.life--;
                } else {
                    particle.update();
                }
            });
            particles = particles.filter(particle => {
                if (particle.type === 'text') {
                    return particle.life > 0;
                } else {
                    return !particle.isDead();
                }
            });
        }
        
        // ===============================
        // ‰∏ªÁªòÂà∂ÂáΩÊï∞
        // ===============================
        function draw() {
            const dayColor = { r: 255, g: 255, b: 255 };
            const nightColor = { r: 26, g: 26, b: 26 };
            
            if (lightningSkillActive) {
                ctx.fillStyle = 'rgba(10, 10, 30, 0.8)';
            } else {
                const bgR = Math.floor(dayColor.r + (nightColor.r - dayColor.r) * themeTransition);
                const bgG = Math.floor(dayColor.g + (nightColor.g - dayColor.g) * themeTransition);
                const bgB = Math.floor(dayColor.b + (nightColor.b - dayColor.b) * themeTransition);
                
                ctx.fillStyle = `rgb(${bgR}, ${bgG}, ${bgB})`;
            }
            
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (lightningSkillActive || currentWeather === 'rainy' || currentWeather === 'snowy') {
                drawWeatherEffects();
            }
            
            drawExplosionEffects();
            
            clouds.forEach(cloud => cloud.draw());
            
            drawGround();
            
            powerUps.forEach(powerUp => powerUp.draw());
            
            dino.draw();
            
            obstacles.forEach(obstacle => obstacle.draw());
            
            enemies.forEach(enemy => enemy.draw());
            
            trucks.forEach(truck => truck.draw());
            
            bombPlanes.forEach(plane => plane.draw());
            
            birdBombs.forEach(bird => bird.draw());
            
            bombs.forEach(bomb => bomb.draw());
            
            enemyFireballs.forEach(fireball => fireball.draw());
            
            fireballs.forEach(fireball => fireball.draw());
            
            drawSuperLaser();
            
            particles.forEach(particle => {
                if (particle.type === 'text') {
                    const alpha = particle.life / particle.maxLife;
                    ctx.globalAlpha = alpha;
                    ctx.fillStyle = particle.color;
                    ctx.font = `${particle.fontSize}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.fillText(particle.text, particle.x, particle.y);
                    ctx.globalAlpha = 1;
                } else {
                    particle.draw();
                }
            });
            
            drawScore();
            
            if (gameOver) {
                drawGameOver();
            }
            
            if (gameRunning && !gameOver && !gamePaused && frameCount < 180) {
                ctx.fillStyle = isDarkMode ? '#f0f0f0' : '#535353';
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Ê∏∏ÊàèÂºÄÂßã', canvas.width / 2, canvas.height / 2 - 30);
                ctx.fillStyle = isDarkMode ? '#f0f0f0' : '#535353';
                ctx.font = '16px Arial';
                ctx.fillText('‰ΩøÁî®‚ÜëÊàñÁ©∫Ê†ºÈîÆË∑≥Ë∑ÉÔºåFÈîÆÂèëÂ∞ÑÁÅ´ÁêÉ', canvas.width / 2, canvas.height / 2);
            }
        }
        
        // ===============================
        // ÈáçÁΩÆÊ∏∏Êàè
        // ===============================
        function resetGame() {
            gameOver = false;
            gameRunning = true;
            gamePaused = false;
            score = 0;
            gameSpeed = 3;
            frameCount = 0;
            gameTime = 0;
            endlessMode = false;
            obstacles = [];
            clouds = [];
            particles = [];
            fireballs = [];
            powerUps = [];
            enemies = [];
            enemyFireballs = [];
            trucks = [];
            birdBombs = [];
            bombPlanes = [];
            bombs = [];
            invincibleTime = 0;
            powerUpTime = 0;
            infinitePenetrationTime = 0;
            hasInfinitePenetration = false;
            isDarkMode = false;
            themeTransition = 0;
            targetDarkMode = false;
            themeTimer = 0;
            lives = 5;
            maxLives = 5;
            lastLifeBonus = 0;
            lastLifeUpBonus = 0;
            lastFireballBonus = 0;
            invulnerableFlash = 0;
            fireballLevel = 1;
            fireballDamage = 1;
            preGMLevel = 1;
            laserActive = false;
            laserCooldown = 0;
            laserDuration = 0;
            laserCharge = 0;
            isFiringLaser = false;
            isFiringMiniLaser = false;
            superLaserActive = false;
            superLaserDuration = 0;
            superLaserChargeProgress = 0;
            superLaserWidth = 20;
            superLaserHeight = canvas.height;
            superLaserExpanding = false;
            superLaserExpandSpeed = 0.2;
            superLaserReady = false;
            isFiringSuperLaser = false;
            barrierCount = 0;
            barrierFlash = 0;
            lightningSkillActive = false;
            lightningSkillDuration = 0;
            lightningSkillCooldown = 0;
            lightningSkillUpgraded = false;
            rainParticles = [];
            snowParticles = [];
            lightningBolts = [];
            explosionEffects = [];
            explosionParticles = [];
            screenShake = 0;
            hitEffect = 0;
            lastDamageTaken = 0;
            lastLightningTime = 0;
            scoreMultiplier = 1;
            healOverTime = 0;
            healOverTimeTimer = 0;
            enemyPowerUps = {
                powerUpTime: 0,
                infinitePenetrationTime: 0,
                damageMultiplier: 1
            };
            
            // Êñ∞Â¢ûÁ≥ªÁªüÈáçÁΩÆ
            hardMode = false;
            nightmareMode = false;
            hellMode = false;
            hardModeMultiplier = 1;
            hardModeStartScore = 0;
            nightmareModeStartScore = 0;
            hellModeStartScore = 0;
            passiveScoreMultiplier = 1;
            passiveBuffMultiplier = 1;
            immuneObstacle = false;
            immuneFireball = false;
            immuneBomb = false;
            
            // Ë∂ÖÁ∫ßÊøÄÂÖâÈÖçÁΩÆÈáçÁΩÆ
            superLaserChargeTime = 20;
            superLaserDamageMultiplier = 16;
            superLaserDurationTime = 15;
            superLaserInstantKill = false;
            
            // Â§©Ê∞îÁ≥ªÁªüÈáçÁΩÆ
            currentWeather = 'sunny';
            weatherTimer = 0;
            
            // 70Á∫ßË¢´Âä®ÊäÄËÉΩÈáçÁΩÆ
            passiveBarrierTimer = 0;
            lastPassiveBarrierScore = 0;
            
            // 160Á∫ßË¢´Âä®ÈáçÁΩÆ
            lastLifeRecoveryBonus = 0;
            
            // ÁâπÊÆäÊïå‰∫∫ÂÜ∑Âç¥Êó∂Èó¥ÈáçÁΩÆ
            specialEnemyCooldowns = {
                truck: 0,
                bombPlane: 0,
                birdBomb: 0
            };
            
            dino.y = canvas.height - 30 - dino.height;
            dino.dy = 0;
            dino.grounded = true;
            dino.ducking = false;
            
            resizeCanvas();
            
            document.getElementById('laserCooldown').style.display = 'none';
            document.getElementById('superLaserCharge').style.display = 'none';
            document.getElementById('lightningCooldown').style.display = 'none';
            document.getElementById('gameOverScreen').style.display = 'none';
            document.getElementById('musicToggle').style.display = 'none';
            document.getElementById('endButton').style.display = 'none';
            document.getElementById('hitBorder').style.display = 'none';
            document.getElementById('difficultyIndicator').style.display = 'none';
            document.getElementById('controls').style.pointerEvents = 'auto';
            
            if (fireballLevel >= 40) {
                document.getElementById('lightningBtn').style.display = 'flex';
            } else {
                document.getElementById('lightningBtn').style.display = 'none';
            }
        }
        
        // ===============================
        // Ê∏∏Êàè‰∏ªÂæ™ÁéØ
        // ===============================
        function gameLoop() {
            if (!gamePaused) {
                update();
                draw();
            }
            requestAnimationFrame(gameLoop);
        }
        
        gameLoop();
        
        // ===============================
        // ÈîÆÁõòÊéßÂà∂
        // ===============================
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.code === 'ArrowUp') {
                e.preventDefault();
                if (!gameRunning && !gameOver) {
                    resetGame();
                } else if (gameOver) {
                    resetGame();
                } else {
                    dino.jump();
                }
            }
            
            if (e.code === 'ArrowDown') {
                e.preventDefault();
                dino.duck(true);
            }
            
            if (e.code === 'KeyF') {
                e.preventDefault();
                if (gameRunning && !gameOver) {
                    if (fireballLevel >= 50) {
                        if (superLaserActive && superLaserReady) {
                            isFiringSuperLaser = true;
                            isFiringMiniLaser = false;
                        } else {
                            isFiringMiniLaser = true;
                            isFiringSuperLaser = false;
                        }
                    } 
                    else if (fireballLevel >= 30) {
                        isFiringMiniLaser = true;
                        isFiringSuperLaser = false;
                    }
                    else if (fireballLevel >= 20 && laserCharge >= 100 && laserCooldown <= 0) {
                        laserActive = true;
                        laserDuration = 5;
                        isFiringLaser = true;
                    }
                    else if (fireballLevel >= 10 && laserCharge >= 100 && laserCooldown <= 0) {
                        laserActive = true;
                        laserDuration = 5;
                        isFiringLaser = true;
                    } else {
                        shootFireball();
                    }
                }
            }
            
            if (e.code === 'KeyL' && fireballLevel >= 40) {
                e.preventDefault();
                activateLightningSkill();
            }
            
            if (e.code === 'Escape') {
                e.preventDefault();
                togglePause();
            }
            
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.code === 'ArrowDown') {
                e.preventDefault();
                dino.duck(false);
            }
            
            if (e.code === 'KeyF') {
                e.preventDefault();
                isFiringLaser = false;
                isFiringSuperLaser = false;
                isFiringMiniLaser = false;
            }
        });
        
        const jumpBtn = document.getElementById('jumpBtn');
        const fireBtn = document.getElementById('fireBtn');
        const lightningBtn = document.getElementById('lightningBtn');
        
        function shootFireball() {
            if (gameRunning && !gameOver && !isFiringLaser && !isFiringSuperLaser && !isFiringMiniLaser && !superLaserActive) {
                const fireballY = dino.y + dino.height / 2 - 6;
                fireballs.push(new Fireball(dino.x + dino.width, fireballY));
            }
        }
        
        jumpBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (!gameRunning && !gameOver) {
                resetGame();
            } else if (gameOver) {
                resetGame();
            } else {
                dino.jump();
            }
        }, { passive: false });
        
        jumpBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (!gameRunning && !gameOver) {
                resetGame();
            } else if (gameOver) {
                resetGame();
            } else {
                dino.jump();
            }
        });
        
        fireBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (gameRunning && !gameOver) {
                if (fireballLevel >= 50) {
                    if (superLaserActive && superLaserReady) {
                        isFiringSuperLaser = true;
                        isFiringMiniLaser = false;
                    } else {
                        isFiringMiniLaser = true;
                        isFiringSuperLaser = false;
                    }
                } 
                else if (fireballLevel >= 30) {
                    isFiringMiniLaser = true;
                    isFiringSuperLaser = false;
                }
                else if (fireballLevel >= 20 && laserCharge >= 100 && laserCooldown <= 0) {
                    laserActive = true;
                    laserDuration = 5;
                    isFiringLaser = true;
                }
                else if (fireballLevel >= 10 && laserCharge >= 100 && laserCooldown <= 0) {
                    laserActive = true;
                    laserDuration = 5;
                    isFiringLaser = true;
                } else {
                    shootFireball();
                }
            }
        }, { passive: false });
        
        fireBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            isFiringLaser = false;
            isFiringSuperLaser = false;
            isFiringMiniLaser = false;
        }, { passive: false });
        
        fireBtn.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (gameRunning && !gameOver) {
                if (fireballLevel >= 50) {
                    if (superLaserActive && superLaserReady) {
                        isFiringSuperLaser = true;
                        isFiringMiniLaser = false;
                    } else {
                        isFiringMiniLaser = true;
                        isFiringSuperLaser = false;
                    }
                } 
                else if (fireballLevel >= 30) {
                    isFiringMiniLaser = true;
                    isFiringSuperLaser = false;
                }
                else if (fireballLevel >= 20 && laserCharge >= 100 && laserCooldown <= 0) {
                    laserActive = true;
                    laserDuration = 5;
                    isFiringLaser = true;
                }
                else if (fireballLevel >= 10 && laserCharge >= 100 && laserCooldown <= 0) {
                    laserActive = true;
                    laserDuration = 5;
                    isFiringLaser = true;
                } else {
                    shootFireball();
                }
            }
        });
        
        fireBtn.addEventListener('mouseup', (e) => {
            e.preventDefault();
            e.stopPropagation();
            isFiringLaser = false;
            isFiringSuperLaser = false;
            isFiringMiniLaser = false;
        });
        
        lightningBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            activateLightningSkill();
        });
        
        lightningBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            activateLightningSkill();
        }, { passive: false });
        
        document.getElementById('continueBtn').addEventListener('click', function() {
            document.getElementById('gameOverScreen').style.display = 'none';
            resetGame();
        });
        
        document.getElementById('endlessBtn').addEventListener('click', function() {
            document.getElementById('gameOverScreen').style.display = 'none';
            endlessMode = true;
            gameOver = false;
            gameRunning = true;
        });
    </script>
</body>
</html>